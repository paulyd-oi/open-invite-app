HANDOFF: P1 NETWORK STORM CONTROLS

SUMMARY
- Created SSOT gate: src/lib/authedGate.ts with isAuthedForNetwork(bootStatus, session) and assertAuthedForNetwork()
- Definition: bootStatus === "authed" AND (session?.user?.id OR session?.effectiveUserId exists)
- Applied gate to high-traffic query call sites: calendar.tsx, social.tsx, friends.tsx, BottomNavigation.tsx
- Added [NET_GATE] DENY logging in DEV mode for denied calls
- Added bootStatus gating to offlineSync queue replay

ROOT CAUSE / STORM VECTORS FOUND
- Multiple queries using only bootStatus === 'authed' without verifying session userId exists
- This allowed network calls to fire during intermediate boot states before session was fully populated
- offlineSync could replay queue immediately on online transition even if not yet authenticated
- BottomNavigation fired 4 badge queries without session check

FIX
- Created isAuthedForNetwork() that requires BOTH bootStatus==='authed' AND userId present
- Applied to all high-traffic queries in main tab screens
- Added bootStatus parameter to useOfflineSync() and gated replay on authed
- MiniCalendar component in friends.tsx now accepts session prop for proper gating

FILES CHANGED
src/lib/authedGate.ts (NEW)
src/app/calendar.tsx
src/app/social.tsx
src/app/friends.tsx
src/components/BottomNavigation.tsx
src/lib/offlineSync.ts
src/app/_layout.tsx

GREP PROOF: isAuthedForNetwork usage

src/lib/authedGate.ts:32:export function isAuthedForNetwork(
src/lib/authedGate.ts:66:export function assertAuthedForNetwork(params: {
src/app/social.tsx:29:import { isAuthedForNetwork } from "@/lib/authedGate";
src/app/social.tsx:590:  const isAuthed = isAuthedForNetwork(bootStatus, session);
src/app/calendar.tsx:43:import { isAuthedForNetwork } from "@/lib/authedGate";
src/app/calendar.tsx:1316:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/calendar.tsx:1590:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/calendar.tsx:1599:    enabled: isAuthedForNetwork(bootStatus, session),
src/components/BottomNavigation.tsx:17:import { isAuthedForNetwork } from "@/lib/authedGate";
src/components/BottomNavigation.tsx:197:    enabled: isAuthedForNetwork(bootStatus, session),
src/components/BottomNavigation.tsx:205:    enabled: isAuthedForNetwork(bootStatus, session),
src/components/BottomNavigation.tsx:213:    enabled: isAuthedForNetwork(bootStatus, session),
src/components/BottomNavigation.tsx:221:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/friends.tsx:75:import { isAuthedForNetwork } from "@/lib/authedGate";
src/app/friends.tsx:111:    enabled: isAuthedForNetwork(bootStatus, session) && !!friendshipId,
src/app/friends.tsx:854:    enabled: isAuthedForNetwork(bootStatus, session) && ...
src/app/friends.tsx:867:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/friends.tsx:886:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/friends.tsx:1060:    enabled: isAuthedForNetwork(bootStatus, session),
src/app/friends.tsx:1072:    enabled: isAuthedForNetwork(bootStatus, session),

GREP PROOF: [NET_GATE] logging

src/lib/authedGate.ts:79:      `[NET_GATE] DENY tag=${tag} bootStatus=${bootStatus ?? "undefined"} userId=${userId}...
src/lib/offlineSync.ts:198:          console.log(`[NET_GATE] DENY tag=offlineReplay bootStatus=${bootStatus ?? "undefined"}`);

EXAMPLE DEV LOG OUTPUT

DENY (blocked):
[NET_GATE] DENY tag=calendarEvents bootStatus=loading userId=none

ALLOW (no log - query proceeds normally via react-query enabled flag)

VERIFICATION RESULTS

npm run typecheck: PASS
bash scripts/ai/verify_frontend.sh: PASS

git show --stat HEAD

commit 80bbacc4aa2aa5dfa041f64a5ba8afa7ad4da117 (HEAD -> main)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 15:12:57 2026 -0800

    P1: Network storm controls - SSOT authedGate for network calls

 src/app/_layout.tsx              |  6 +-
 src/app/calendar.tsx             |  7 +-
 src/app/friends.tsx              | 31 +-
 src/app/social.tsx               |  5 +-
 src/components/BottomNavigation.tsx |  9 +-
 src/lib/authedGate.ts            | 84 ++++++
 src/lib/offlineSync.ts           | 13 +-
 7 files changed, 130 insertions(+), 25 deletions(-)

git show --name-only HEAD

commit 80bbacc4aa2aa5dfa041f64a5ba8afa7ad4da117 (HEAD -> main)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 15:12:57 2026 -0800

    P1: Network storm controls - SSOT authedGate for network calls

src/app/_layout.tsx
src/app/calendar.tsx
src/app/friends.tsx
src/app/social.tsx
src/components/BottomNavigation.tsx
src/lib/authedGate.ts
src/lib/offlineSync.ts

REMAINING CALL SITES NOT YET MIGRATED

The following files still use bootStatus === 'authed' without isAuthedForNetwork:
- src/app/blocked-contacts.tsx
- src/hooks/useUnseenNotifications.ts
- src/app/account-center.tsx
- src/lib/activeProfileContext.tsx
- src/app/create-event-request.tsx
- src/hooks/useSuggestionsFeed.ts
- src/app/friend/[id].tsx
- src/components/ReconnectReminder.tsx
- src/app/event/[id].tsx
- src/app/user/[id].tsx
- src/app/suggestions.tsx
- src/app/create.tsx
- src/app/discover.tsx
- src/components/SuggestedTimesPicker.tsx
- src/app/event/edit/[id].tsx
- src/components/MutualFriends.tsx
- src/app/invite.tsx
- src/app/circles.tsx
- src/app/event-request/[id].tsx
- src/app/activity.tsx
- src/app/achievements.tsx
- src/app/settings.tsx
- src/app/profile.tsx
- src/components/SuggestionFeedCard.tsx
- src/app/referrals.tsx
- src/app/circle/[id].tsx
- src/lib/useSubscription.ts
- src/app/whos-free.tsx
- src/components/EventPhotoGallery.tsx

These are lower-traffic screens that can be migrated incrementally.
The critical high-traffic paths (main tabs, navigation, offline sync) are now gated.

STATUS
COMPLETE - Commit 80bbacc
