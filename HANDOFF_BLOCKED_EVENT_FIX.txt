# HANDOFF: P0 Fix — Wrong "This time is blocked" for Friend's Open Invite Event

**Commit**: `65048c9` "fix(p0): blocked event visibility + privacy copy fix"
**Branch**: main (pushed to origin/main)
**Status**: ✅ COMPLETE

---

## Summary

Fixed authz/visibility bug where friends viewing Open Invite events incorrectly saw "This time is blocked" instead of event details. Also corrected privacy copy and added profile CTA.

---

## Root Cause

**File**: `src/lib/api.ts` line 87
**Function**: `fetchFn()`
**Why**: The API client had a blanket rule that returned `null` for ALL 404 GET requests instead of throwing the error. This was intended to prevent console spam for optional endpoints, but it also swallowed 403/404 privacy errors from `/api/events/:id`.

**Chain of failure**:
1. Backend returns 403/404 with `code: 'NOT_FRIEND'` and host info
2. `api.ts` catches the 404, returns `null` instead of throwing
3. `eventError` is never set (undefined)
4. `isPrivacyRestricted` check fails (no error to check)
5. `event` is null, `isPrivacyRestricted` is false
6. Fallback UI shows "This time is blocked" (wrong!)

---

## Fix

### 1. `src/lib/api.ts` — Preserve 404 for event detail endpoints

```typescript
// EXCEPTION: Event detail endpoints need the error preserved for privacy handling
if (error.status === 404 && method === "GET") {
  const isEventDetailEndpoint = /^\/api\/events\/[^/]+$/.test(path);
  if (!isEventDetailEndpoint) {
    return null as T;
  }
  // For event detail endpoints, re-throw to let caller handle privacy logic
}
```

### 2. `src/app/event/[id].tsx` — SSOT visibility classification + DEV logging

Added:
- `restrictedHostName` extraction from error payload
- `getBlockedReason()` SSOT classifier with types: `private_event | busy_block | authorized | unknown`
- DEV logging with `[P0_BLOCKED_EVENT]` tag

### 3. Updated UI copy

**Before** (wrong):
```
Title: "This time is blocked"
Copy: "This event is private, or you're marked as busy at this time."
CTA: Go Back
```

**After** (correct):

For private events:
```
Title: "This event is private"
Copy: "Add {hostName} to see event details."
CTA: View Profile (navigates to /user/{hostId})
     Go Back
```

For unknown/deleted:
```
Title: "Event not available"
Copy: "This event may have been deleted or is no longer available."
CTA: Go Back
```

---

## DEV Proof Log Examples

### Authorized path (friend viewing Open Invite):
```
[P0_BLOCKED_EVENT] Visibility decision: {
  eventId: "abc123",
  hasEvent: true,
  eventType: "open_invite",
  authorized: true,
  reason: "authorized"
}
```

### Private path (non-friend viewing private event):
```
[P0_BLOCKED_EVENT] Event fetch error: {
  eventId: "xyz789",
  status: 403,
  code: "NOT_FRIEND",
  hasHostInfo: true,
  hostName: "Jane Doe",
  isPrivacyRestricted: true
}

[P0_BLOCKED_EVENT] Visibility decision: {
  eventId: "xyz789",
  hasEvent: false,
  eventType: "open_invite",
  authorized: false,
  reason: "private_event"
}
```

### Busy block path:
```
[P0_BLOCKED_EVENT] Visibility decision: {
  eventId: "busy456",
  hasEvent: true,
  eventType: "busy_block",
  authorized: false,
  reason: "busy_block"
}
```

---

## Manual Test Plan

| Scenario | Expected Result |
|----------|-----------------|
| Friend views Open Invite event | ✅ Full event details shown |
| Non-friend views private event | ✅ "This event is private" + "Add {hostName}" + View Profile CTA |
| User views deleted event | ✅ "Event not available" |
| User views own busy block | ✅ Busy block UI (not tested in this fix, unchanged) |

---

## Verification

```
✅ npm run typecheck         → PASS
✅ verify_frontend.sh        → PASS
✅ git push origin main      → 65048c9 pushed
```

---

## git show --stat HEAD

```
commit 65048c9a02ca057f3d8c6808304241a5f72ee145 (HEAD -> main, origin/main, origin/HEAD)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 10:15:57 2026 -0800

    fix(p0): blocked event visibility + privacy copy fix

 HANDOFF_ONBOARDING_BOOT_JITTER.txt | 205 ++++++
 src/app/event/[id].tsx             |  83 ++-
 src/app/event/edit/[id].tsx        |   4 +-
 src/lib/api.ts                     |   8 +-
 4 files changed, 284 insertions(+), 16 deletions(-)
```

---

## git show --name-only HEAD

```
commit 65048c9a02ca057f3d8c6808304241a5f72ee145 (HEAD -> main, origin/main, origin/HEAD)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 10:15:57 2026 -0800

    fix(p0): blocked event visibility + privacy copy fix

HANDOFF_ONBOARDING_BOOT_JITTER.txt
src/app/event/[id].tsx
src/app/event/edit/[id].tsx
src/lib/api.ts
```
