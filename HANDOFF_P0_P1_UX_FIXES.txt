═══════════════════════════════════════════════════════════════════════════════
HANDOFF: P0 + P1 UX FIXES
Date: 2025-01-26
Branch: main
Repo: open-invite-app (frontend fixes only)
═══════════════════════════════════════════════════════════════════════════════

## SUMMARY

Fixed 7 P0/P1 issues related to:
- Onboarding loop (bootstrap refresh)
- Lifetime subscription premium status
- Apple Sign-In error diagnostics
- Bottom sheet safe area clipping
- Keyboard covering inputs
- Location permission request
- Friend notes error logging

═══════════════════════════════════════════════════════════════════════════════

## CHANGES BY FILE

### src/app/welcome.tsx
- Added import: requestBootstrapRefreshOnce from useBootAuthority
- Enhanced Apple Sign-In backend failure logging with httpStatus, responseBody
- Enhanced native error logging with fullError object
- Called requestBootstrapRefreshOnce() after successful profile save

### src/lib/SubscriptionContext.tsx
- Fixed isPremium detection for lifetime subscriptions
- Now checks: tier === "premium" || tier === "pro" || isLifetime || isPro
- Added DEV logging for tier/isPremium mapping

### src/app/create.tsx
- Added locationPermissionAsked state
- Added requestAndFetchLocation callback that requests permission
- Updated place search useEffect to request permission on first search
- Moved userLocation state declaration before callbacks to fix TS error

### src/app/friend/[id].tsx
- Enhanced addNoteMutation onError with status/body/fullError logging
- Enhanced deleteNoteMutation onError with status/body logging

### src/components/ConfirmModal.tsx
- Added useSafeAreaInsets import and usage
- Updated paddingBottom to use Math.max(insets.bottom, 20) + 8

### src/components/CreateCircleModal.tsx
- Added useSafeAreaInsets import and usage
- Updated modal container paddingBottom to respect insets

### src/components/UpgradeModal.tsx
- Added useSafeAreaInsets import and usage
- Updated card marginBottom to use Math.max(insets.bottom, 8) + 8

### src/components/EventSummaryModal.tsx
- Added useSafeAreaInsets import and usage
- Updated actions paddingBottom to use Math.max(insets.bottom, 20) + 8

### src/app/circle/[id].tsx
- Added useSafeAreaInsets import
- Added insets hook in component
- Wrapped Group Settings Modal in KeyboardAvoidingView
- Updated modal paddingBottom to respect safe area insets

### docs/STATE_OF_THE_APP.md
- Added session fixes to "Fixed This Session" section
- Added new stable features (Lifetime, Location, Bottom sheets, Keyboard)

═══════════════════════════════════════════════════════════════════════════════

## VERIFICATION

✅ TypeScript: npm run typecheck - PASS
✅ ESLint: npm run lint - PASS (only pre-existing warnings)
✅ No runtime tested (TestFlight recommended)

═══════════════════════════════════════════════════════════════════════════════

## TESTING CHECKLIST

### P0-A: Onboarding Loop
- [ ] Fresh signup completes all slides without loop
- [ ] Profile save shows "Profile saved successfully" log
- [ ] Bootstrap refresh triggered after profile save (check logs)
- [ ] Photo upload failure does not block flow

### P0-B: Lifetime = Premium
- [ ] Lifetime subscriber sees isPremium: true in console log
- [ ] Premium features unlocked for lifetime users

### P0-C: Apple Sign-In Diagnostics
- [ ] Failed Apple Sign-In shows AUTH_TRACE log with httpStatus
- [ ] Error object logged with fullError property
- [ ] User sees meaningful error message

### P1-D: Bottom Sheets Safe Area
- [ ] ConfirmModal not clipped on iPhone with home indicator
- [ ] CreateCircleModal not clipped
- [ ] UpgradeModal not clipped
- [ ] EventSummaryModal not clipped

### P1-E: Keyboard Covering Inputs
- [ ] Group Settings description edit: keyboard doesn't cover input
- [ ] Modal lifts when keyboard appears

### P1-F: Location Permission
- [ ] First place search triggers permission dialog
- [ ] Permission granted: search results biased by location
- [ ] Permission denied: search still works (no location bias)

### P1-G: Friend Notes Error Logging
- [ ] Failed note add shows [FriendNotes] log with status/body
- [ ] User sees error message

═══════════════════════════════════════════════════════════════════════════════

## KNOWN LIMITATIONS

1. Backend returns tier values not fully typed (free/premium/pro/lifetime)
   - Fixed with string cast for flexible comparison

2. Location permission only requested on first search
   - If denied, user won't be prompted again (OS behavior)

3. Pre-existing lint warnings remain
   - These are in unrelated files, not from this PR

═══════════════════════════════════════════════════════════════════════════════

## NEXT STEPS

1. TestFlight build for testing
2. Verify Apple Sign-In on real device
3. Verify onboarding flow end-to-end
4. Check bottom sheet appearance on iPhone 14/15 Pro

═══════════════════════════════════════════════════════════════════════════════
