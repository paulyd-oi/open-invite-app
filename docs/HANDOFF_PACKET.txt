================================================================================
HANDOFF PACKET: P0 Stop-Ship Fixes (Frontend Pass 1)
================================================================================
Generated: 2026-01-23
Session: Frontend P0 bug fixes for release
================================================================================

SUMMARY
-------
Fixed 3 critical stop-ship issues in the Open Invite frontend:

1. ONBOARDING PHOTO UPLOAD CRASH + AUTH REDIRECT
   - Replaced deprecated ImagePicker.MediaTypeOptions.Images with ["images"]
   - Changed token check from SecureStore (hasAuthToken) to session-based (getSessionCached)
   - Onboarding now proceeds if cookie session is valid, even without SecureStore token
   - Upload errors handled gracefully without crash or redirect

2. FALSE "VERIFY YOUR EMAIL" BANNER
   - Banner now checks session.user.emailVerified === false before showing
   - If user is verified (emailVerified === true), banner never renders
   - Waits for session to load before checking (no flash of incorrect state)

3. PREMIUM USER SHOWN AS "FREE"
   - Plan row now shows "Loading..." while entitlements are being fetched
   - Prevents false "Free" display that flashes before premium status loads
   - Upgrade CTA still properly gated (only shows for non-premium users)


REPO CONFIRMATION
-----------------
Path: /Users/paulsmbp/Documents/GitHub/open-invite-app
Remote: https://github.com/paulyd-oi/open-invite-app.git
Branch: main
Status: Clean after commit


FILES CHANGED
-------------
1. src/app/welcome.tsx
   - Added import for getSessionCached from @/lib/sessionCache
   - Changed MediaTypeOptions.Images to ["images"] (line ~512)
   - Changed handleSlide3Continue session check from hasAuthToken to getSessionCached
   - Changed uploadPhotoInBackground session check from hasAuthToken to getSessionCached

2. src/app/social.tsx
   - Updated checkVerificationStatus effect to check session.user.emailVerified
   - Added sessionLoading dependency to avoid flash of incorrect state
   - Banner only shows when emailVerified === false AND deferred === true

3. src/app/settings.tsx
   - Plan row status now shows "Loading..." when entitlementsLoading is true
   - Prevents false "Free" from displaying during entitlements fetch

4. eas.json
   - Added development-simulator build profile (unrelated to P0 fixes)


KEY DIFFS
---------

A. welcome.tsx - MediaTypeOptions fix (line ~512):
BEFORE:
  mediaTypes: ImagePicker.MediaTypeOptions.Images,

AFTER:
  mediaTypes: ["images"],


B. welcome.tsx - Session check for Continue (lines ~529-540):
BEFORE:
  const hasToken = await hasAuthToken();
  if (!hasToken) {
    console.log("[Onboarding] No auth token, redirecting to login");
    router.replace("/login");
    return;
  }

AFTER:
  try {
    const sessionResult = await getSessionCached();
    if (!sessionResult?.user?.id) {
      console.log("[Onboarding] No valid session, redirecting to login");
      router.replace("/login");
      return;
    }
  } catch (sessionErr) {
    console.log("[Onboarding] Session check failed, redirecting to login");
    router.replace("/login");
    return;
  }


C. social.tsx - Verification banner gating (lines ~369-392):
BEFORE:
  useEffect(() => {
    const checkVerificationStatus = async () => {
      const deferred = await AsyncStorage.getItem("verification_deferred");
      const dismissed = await AsyncStorage.getItem("verification_banner_dismissed");
      if (deferred === "true" && dismissed !== "true") {
        setShowVerificationBanner(true);
      }
    };
    checkVerificationStatus();
  }, []);

AFTER:
  useEffect(() => {
    const checkVerificationStatus = async () => {
      // First check if user is already verified via session - if so, never show banner
      if (session?.user?.emailVerified === true) {
        setShowVerificationBanner(false);
        return;
      }
      // Only show banner if explicitly deferred AND not dismissed AND not verified
      const deferred = await AsyncStorage.getItem("verification_deferred");
      const dismissed = await AsyncStorage.getItem("verification_banner_dismissed");
      if (deferred === "true" && dismissed !== "true" && session?.user?.emailVerified === false) {
        setShowVerificationBanner(true);
      } else {
        setShowVerificationBanner(false);
      }
    };
    if (!sessionLoading) {
      checkVerificationStatus();
    }
  }, [session, sessionLoading]);


D. settings.tsx - Plan status loading state (lines ~1817-1821):
BEFORE:
  {userIsPremium ? "Active" : "Free"}

AFTER:
  {entitlementsLoading ? "Loading..." : userIsPremium ? "Active" : "Free"}


TEST RESULTS
------------
Command: npm run typecheck
Result: PASSED (no errors)


MANUAL TEST PLAN
----------------
1. FRESH ONBOARDING TEST:
   - Create new account
   - Reach profile setup screen (Slide 3)
   - Add photo (optional) - should not crash
   - Tap Continue - should not redirect to login if session exists
   - Verify logs show session check, not token check

2. EMAIL VERIFICATION BANNER TEST:
   - Log in with verified account
   - Navigate to Social screen
   - Confirm: No "Verify your email" banner appears
   - (If testing unverified account: banner should appear only if deferred)

3. PREMIUM STATUS TEST:
   - Log in with Lifetime Pro account
   - Navigate to Settings
   - Plan row should show "Loading..." briefly, then "Active"
   - Should NOT flash "Free" at any point
   - "Upgrade to Premium" row should be hidden


COMMIT + PUSH
-------------
Commit: abf9508
Message: "fix(p0): onboarding photo crash + email verify + premium gating"
Push: YES (to origin/main)
Files: 4 changed, 54 insertions(+), 14 deletions(-)


RISKS / FOLLOW-UPS
------------------
1. eas.json change included (development-simulator profile) - unrelated to P0 fixes
   but was already modified in working tree. Low risk.

2. Photo upload still best-effort (no retry mechanism). If upload fails, user
   continues without avatar but can add later from profile. Acceptable for P0.

3. Session check uses getSessionCached which may return stale session in edge cases.
   Cookie session is still source of truth; this is improvement over hard token requirement.


END OF HANDOFF PACKET
================================================================================
