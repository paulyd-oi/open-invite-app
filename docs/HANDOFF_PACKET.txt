================================================================================
HANDOFF PACKET: P1 Fixes (Frontend Pass 2)
================================================================================
Generated: 2026-01-23
Session: Frontend P1 bug fixes
================================================================================

SUMMARY
-------
Fixed 3 P1 issues in the Open Invite frontend:

1. #7 - GET STARTED GUIDE FIRST-LOGIN ONLY
   - Changed from device-level key (onboarding_seen_v1) to user-specific key (guide_seen::<userId>)
   - Guide only auto-opens if user has valid session AND hasn't seen it before
   - Long-time users will NEVER see guide popup again
   - "Maybe later" dismiss marks user as seen (no repeat spam)
   - Settings > Get Started Guide still works for manual access

2. #9 - ADMIN CONSOLE BADGES UI RESTORED
   - Added visible "BADGES" section in Admin Console overview
   - Shows "Manage User Badges" tile with Award icon
   - Provides clear instructions: "Search for a user below to grant or revoke badges"
   - Badge grant/revoke functionality works after selecting a user

3. #13 - CREATE EVENT USES CIRCLES (NOT LEGACY GROUPS)
   - Changed create.tsx query from /api/groups to /api/circles
   - Changed edit/[id].tsx query from /api/groups to /api/circles
   - Updated UI labels: "Groups" → "Circles"
   - Updated empty state text: "No circles yet. Create circles from Friends tab!"
   - Circle items display emoji instead of color-coded Users icon


REPO CONFIRMATION
-----------------
Path: /Users/paulsmbp/Documents/GitHub/open-invite-app
Remote: https://github.com/paulyd-oi/open-invite-app.git
Branch: main
Status: Clean after commit


FILES CHANGED
-------------
1. src/app/calendar.tsx
   - Changed ONBOARDING_SEEN_KEY to GUIDE_SEEN_KEY_PREFIX with user-specific format
   - Updated checkFirstLogin effect to require session.user.id
   - Updated handleDismissGuide and handleOpenGuide to use user-specific key

2. src/app/admin.tsx
   - Added Award import from @/ui/icons
   - Added BADGES section between OVERVIEW and USER LOOKUP
   - Shows "Manage User Badges" tile with instructions

3. src/app/create.tsx
   - Changed imports: GetGroupsResponse → GetCirclesResponse, FriendGroup → Circle
   - Changed query: /api/groups → /api/circles
   - Updated UI labels and rendering for Circle objects

4. src/app/event/edit/[id].tsx
   - Same changes as create.tsx for consistency
   - "Groups" button label → "Circles"


KEY DIFFS
---------

A. calendar.tsx - Guide key change:
BEFORE:
  const ONBOARDING_SEEN_KEY = "onboarding_seen_v1";

AFTER:
  const GUIDE_SEEN_KEY_PREFIX = "guide_seen::";
  // Usage: `${GUIDE_SEEN_KEY_PREFIX}${userId}`


B. calendar.tsx - First login check:
BEFORE:
  useEffect(() => {
    const checkFirstLogin = async () => {
      const hasSeenGuide = await AsyncStorage.getItem(ONBOARDING_SEEN_KEY);
      if (!hasSeenGuide) {
        setTimeout(() => setShowFirstLoginGuide(true), 500);
      }
    };
    checkFirstLogin();
  }, []);

AFTER:
  useEffect(() => {
    const checkFirstLogin = async () => {
      const userId = session?.user?.id;
      if (!userId) return;
      
      const guideSeenKey = `${GUIDE_SEEN_KEY_PREFIX}${userId}`;
      const hasSeenGuide = await AsyncStorage.getItem(guideSeenKey);
      if (!hasSeenGuide) {
        setTimeout(() => setShowFirstLoginGuide(true), 500);
      }
    };
    checkFirstLogin();
  }, [session?.user?.id]);


C. admin.tsx - Badges section (NEW):
  {/* Badges Management Section */}
  <Animated.View entering={FadeInDown.delay(175).springify()} className="mx-4 mt-6">
    <Text style={{ color: colors.textSecondary }}>BADGES</Text>
    <View style={{ backgroundColor: colors.surface }}>
      <Award size={20} color={themeColor} />
      <Text>Manage User Badges</Text>
      <Text>Search for a user below to grant or revoke badges</Text>
    </View>
  </Animated.View>


D. create.tsx & edit/[id].tsx - Circles query:
BEFORE:
  const { data: groupsData } = useQuery({
    queryKey: ["groups"],
    queryFn: () => api.get<GetGroupsResponse>("/api/groups"),
  });
  const groups = groupsData?.groups ?? [];

AFTER:
  const { data: circlesData } = useQuery({
    queryKey: ["circles"],
    queryFn: () => api.get<GetCirclesResponse>("/api/circles"),
  });
  const circles = circlesData?.circles ?? [];


TEST RESULTS
------------
Command: npm run typecheck
Result: PASSED (no errors)


MANUAL TEST PLAN
----------------
1. GUIDE FIRST-LOGIN TEST:
   ✓ Existing user login → Guide does NOT auto-popup
   ✓ New user (or clear guide_seen::<userId> key) → Guide pops once
   ✓ Dismiss guide → Never shows again for that user
   ✓ Settings > Get Started Guide → Still accessible manually

2. ADMIN CONSOLE BADGES TEST:
   ✓ Log in as Platform Admin
   ✓ Go to Settings > Admin Console
   ✓ Confirm "BADGES" section visible between OVERVIEW and USER LOOKUP
   ✓ Search for user → Select → Badge management appears

3. CREATE EVENT CIRCLES TEST:
   ✓ Create Event → Visibility section shows "Circles" option
   ✓ Select "Circles" → Shows list from /api/circles (not /api/groups)
   ✓ Circle items show emoji, not color icon
   ✓ Edit Event → Same behavior


COMMIT + PUSH
-------------
Commit: 68f0497
Message: "fix(p1): guide gating + admin badges + circles in create-event"
Push: YES (to origin/main)
Files: 4 changed, 82 insertions(+), 46 deletions(-)


RISKS / FOLLOW-UPS
------------------
1. Existing users who saw guide before (device-level key) will see it ONCE more
   with the new user-specific key. This is acceptable - ensures fresh clean slate.

2. The internal visibility value "specific_groups" is kept for backend compatibility.
   Only UI labels changed to "Circles". Future refactor could rename this constant.

3. Edit event screen loads existing groupVisibility[] from event. If old events
   had legacy group IDs, they may not match new circle IDs. Backend handles this.


END OF HANDOFF PACKET
================================================================================
