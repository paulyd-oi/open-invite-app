HANDOFF PACKET: Push Permission + Calendar Import Nudge
========================================================
Date: 2026-02-01
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Verified push permission prompts stay off Settings mount.
Added calendar import nudge banner on Calendar screen.
Updated Settings copy to clarify one-time import.

TASK A: PUSH PERMISSION OFF SETTINGS - VERIFIED
-----------------------------------------------
Settings does NOT trigger any push permission request on mount.
- Searched all requestPermissionsAsync callsites (9 total)
- None are in settings.tsx
- useNotifications hook in settings only used for runPushDiagnostics/clearMyPushTokens
- Push permission system prompt only happens via:
  1. NotificationPrePromptModal (soft nudge first)
  2. User explicit tap on "Enable" in the modal
  3. registerPush flow (after user consent)

TASK B: PUSH PERMISSION AT HIGH-INTENT MOMENT - ALREADY EXISTS
--------------------------------------------------------------
Event Detail (src/app/event/[id].tsx):
- Lines 583-596: After RSVP going/interested, checks shouldShowNotificationPrompt()
- Shows NotificationPrePromptModal after 600ms delay
- Only "Enable" tap triggers Notifications.requestPermissionsAsync()
- Respects 14-day cooldown via markNotificationPromptAsked()

Create Event (src/app/create.tsx):
- Lines 592+: Same pattern after event creation success

TASK C: CALENDAR IMPORT NUDGE ON CALENDAR - IMPLEMENTED
-------------------------------------------------------
File: src/app/calendar.tsx
Added lightweight inline banner near top of calendar:

State:
- showCalendarImportNudge: boolean (controls banner visibility)
- calendarImportNudgeChecked: boolean (prevents re-checking)

Logic:
- On mount (authed), checks if calendar permission NOT granted
- Also checks AsyncStorage for calendar_import_nudge_dismissed:{userId}
- If not granted AND not dismissed, shows banner after 800ms

Banner UI:
- CalendarDays icon + "Import your calendar" heading
- "One-time import. Your data stays private." subtext
- "Import" button navigates to /import-calendar
- X button dismisses and persists dismissal

NO system prompt called from banner.

TASK D: SETTINGS COPY UPDATE - IMPLEMENTED
------------------------------------------
File: src/app/settings.tsx (line 2198)
Before: title="Import Calendar" subtitle="Add events from Apple or Google Calendar"
After:  title="Import Device Calendar" subtitle="One-time import from Apple or Google Calendar"

FILES CHANGED
-------------
1. src/app/calendar.tsx
   - Added import: checkCalendarPermission from lib/calendarSync
   - Added import: CalendarDays icon
   - Added state: showCalendarImportNudge, calendarImportNudgeChecked
   - Added useEffect: checks permission + dismissed flag on mount
   - Added handlers: handleDismissCalendarImportNudge, handleCalendarImportNudgePress
   - Added UI: Calendar import nudge banner before ScrollView

2. src/app/settings.tsx
   - Updated Calendar section title: "Import Device Calendar"
   - Updated Calendar section subtitle: "One-time import from Apple or Google Calendar"

VERIFICATION
------------
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS

MANUAL TEST PLAN
----------------
1. Open Settings - should NOT see any push permission iOS alert
2. Navigate to Calendar screen
   - If calendar permission not granted, see "Import your calendar" banner
   - Tap "Import" goes to /import-calendar
   - Tap X dismisses banner, never returns (per-user)
3. Create event or RSVP "Going" on an event
   - See soft notification nudge modal (if not shown recently)
   - "Enable" triggers iOS permission alert
   - "Not Now" closes modal, 14-day cooldown starts
4. Settings "Import Device Calendar" row
   - Shows "One-time import from Apple or Google Calendar"
   - Tapping goes to /import-calendar

RISKS / NOTES
-------------
- Calendar nudge only shows if permission not already granted
- 14-day cooldown on notification soft-ask prevents over-prompting
- Per-user dismissal flags keyed by userId survive logout/re-login
