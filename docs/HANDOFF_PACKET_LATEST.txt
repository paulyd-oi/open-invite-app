HANDOFF PACKET â€” PUSH DIAGNOSTICS + FORCED TOKEN REGISTRATION
==============================================================
Date: 2026-01-30
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Added production-safe Push Diagnostics feature for TestFlight testing.
- New runPushDiagnostics() function in useNotifications hook
- Settings screen "Push Diagnostics" row (allowlist-gated)
- Verifies: auth status, permission, token validity, backend registration
- Returns: permission status, token prefix, backend active count

PROBLEM SOLVED
--------------
Backend shows only fake token "ExponentPushToken[test123]" because no real
device token was ever registered. This feature forces token registration
and provides proof that the real token is now in backend.

FILES CHANGED
-------------
1. src/hooks/useNotifications.ts
   - Added runPushDiagnostics() async function
   - Returns { ok, reason, permission?, tokenPrefix?, backendActiveCount? }
   - Production-safe logging (no secrets, no full tokens)
   - Exported in hook return object

2. src/app/settings.tsx
   - Imported useNotifications hook
   - Added PUSH_DIAG_ALLOWLIST for gating visibility
   - Added isPushDiagRunning state
   - Added handlePushDiagnostics() handler with safeToast feedback
   - Added "Push Diagnostics" SettingItem in Notifications section

KEY DIFFS
---------
useNotifications.ts:
+const runPushDiagnostics = useCallback(async (): Promise<{
+  ok: boolean; reason: string; permission?: string;
+  tokenPrefix?: string; backendActiveCount?: number;
+}> => { ... }, [bootStatus, session?.user, isValidPushToken]);
+return { ..., runPushDiagnostics };

settings.tsx:
+import { useNotifications } from "@/hooks/useNotifications";
+const PUSH_DIAG_ALLOWLIST = ["pauljdal@gmail.com", ...];
+const { runPushDiagnostics } = useNotifications();
+const showPushDiagnostics = PUSH_DIAG_ALLOWLIST.some(...)
+{showPushDiagnostics && <SettingItem ... onPress={handlePushDiagnostics} />}

COMMANDS RUN
------------
npm run typecheck -> PASS
bash scripts/ai/verify_frontend.sh -> PASS

TESTFLIGHT VERIFICATION STEPS
-----------------------------
1. Install TestFlight build on real iOS device
2. Sign in with allowlisted email (pauljdal@gmail.com, etc.)
3. Navigate: Settings tab (gear icon)
4. Scroll to NOTIFICATIONS section
5. Tap "Push Diagnostics" row
6. Expected toast:
   - Success: "Push token registered (Active tokens: 1)"
   - Or appropriate error message
7. Check Xcode console for logs:
   [PUSH_DIAG] start
   [PUSH_DIAG] permission=granted
   [PUSH_DIAG] tokenPrefix=ExponentPushToken[xxxx...
   [PUSH_DIAG] backendActiveCount=1
   [PUSH_DIAG] success

PROOF VERIFICATION
------------------
After tapping Push Diagnostics:
1. Backend GET /api/notifications/device-tokens should show:
   - A REAL token (NOT "test123")
   - Token starting with "ExponentPushToken[" followed by 22+ chars
2. Active count >= 1 in toast

SUCCESS CRITERIA
----------------
[x] runPushDiagnostics() returns structured result
[x] Allowlist gates visibility (only testers see the row)
[x] Production-safe logs (no secrets)
[x] Toast feedback for all outcomes
[x] Typecheck passes
[x] verify_frontend.sh passes

RISKS / ROLLBACKS
-----------------
- Minimal risk: feature is allowlist-gated
- Rollback: revert src/hooks/useNotifications.ts + src/app/settings.tsx
- No new dependencies
- No navigation changes
