========================================
HANDOFF PACKET - Global Push Token Registration
========================================
Date: 2025-01-29
Branch: main
Author: GitHub Copilot (Claude Opus 4.5)

========================================
SUMMARY
========================================
Moved useNotifications() from social.tsx to _layout.tsx BootRouter
so push token registration happens globally on auth, not only when
Social tab is mounted.

PROBLEM: Push tokens never registered because useNotifications() was
only called when user visited Social tab. Most users land on Calendar
first and never see Social, so tokens never register.

FIX: Mount useNotifications() in BootRouter (global authed shell).
The hook internally gates on bootStatus === 'authed' && session?.user,
so no changes to the hook logic were needed.

========================================
FILES CHANGED
========================================
src/app/_layout.tsx
  - Added import: useNotifications from @/hooks/useNotifications
  - Added useNotifications() call in BootRouter after entitlements hooks
  - Added DEV-only log: [BootRouter] authed shell mounted for push bootstrap
  - Added loggedPushBootstrapOnceRef to prevent log spam

src/app/social.tsx
  - Removed import: useNotifications from @/hooks/useNotifications
  - Removed useNotifications() call
  - Added comment: NOTE: useNotifications() moved to _layout.tsx BootRouter

========================================
KEY DIFFS
========================================
_layout.tsx (BootRouter):
+ import { useNotifications } from '@/hooks/useNotifications';

+ // Register push notifications globally (gates on bootStatus === 'authed' internally)
+ useNotifications();
+
+ // DEV-only: Log once when authed shell is mounted for push bootstrap
+ const loggedPushBootstrapOnceRef = useRef(false);
+ useEffect(() => {
+   if (bootStatus === 'authed' && session?.user?.id && !loggedPushBootstrapOnceRef.current) {
+     loggedPushBootstrapOnceRef.current = true;
+     if (__DEV__) {
+       console.log('[BootRouter] authed shell mounted for push bootstrap');
+     }
+   }
+ }, [bootStatus, session?.user?.id]);

social.tsx:
- import { useNotifications } from "@/hooks/useNotifications";
- useNotifications();
+ // NOTE: useNotifications() moved to _layout.tsx BootRouter for global push registration

========================================
VERIFICATION
========================================
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS
- AUTH_CONTRACT.md exists
- No !!session gating found
- No uppercase Cookie headers
- Guidance keys user-scoped
- Invariant check PASSED

========================================
RUNTIME STATUS
========================================
On app launch with authed user, expect DEV logs:
  [BootRouter] authed shell mounted for push bootstrap, userId: abc12345...
  [PUSH_BOOTSTRAP] Boot complete, initiating push registration
  [PUSH_BOOTSTRAP] Initial permission status: <status>
  [PUSH_BOOTSTRAP] Requesting permission from OS... (if undetermined)
  [PUSH_BOOTSTRAP] Getting push token...
  [PUSH_BOOTSTRAP] Got valid token: ExponentPushToken[...
  [PUSH_BOOTSTRAP] Token registered with /api/notifications/register-token
  [PUSH_BOOTSTRAP] ✓ Push registration complete

========================================
COLD-START TEST CHECKLIST (TestFlight)
========================================
1. Delete app from iPhone (or clear storage)
2. Install TestFlight build
3. Log in with test account
4. Do NOT visit Social tab - stay on Calendar
5. Within 10 seconds, verify in backend:

   a) GET /api/notifications/device-tokens
      Expected: Shows real ExponentPushToken[...], NOT test123
      Expected: activeCount >= 1

   b) GET /api/notifications/snapshot?userId=<USER_ID>
      Expected: pushPermissionStatus = "granted"
      Expected: tokens.active >= 1

6. Trigger test push:
   POST /api/notifications/test-push
   Body: { "userId": "<USER_ID>" }
   Expected: success = true
   Expected: Device receives push notification

========================================
PROOF LOGS (expected in DEV console)
========================================
[BootRouter] authed shell mounted for push bootstrap, userId: abc12345...
[PUSH_BOOTSTRAP] Boot complete, initiating push registration
[PUSH_BOOTSTRAP] Initial permission status: undetermined
[PUSH_BOOTSTRAP] Requesting permission from OS...
[PUSH_BOOTSTRAP] Permission after request: granted
[PUSH_BOOTSTRAP] Getting push token...
[PUSH_BOOTSTRAP] Got valid token: ExponentPushToken[abc123...
[PUSH_BOOTSTRAP] Token registered with /api/notifications/register-token
[PUSH_BOOTSTRAP] Permission status updated to granted
[PUSH_BOOTSTRAP] ✓ Push registration complete

========================================
INVARIANTS PRESERVED
========================================
- No new dependencies
- useNotifications() hook unchanged (internal gating preserved)
- bootStatus gating maintained
- No login flashes (hook only runs when authed)
- Minimal diff (moved 2 lines between files + added DEV log)

========================================
END OF HANDOFF
========================================
