HANDOFF PACKET â€” APPLE LOGIN COOKIE FIX + LEGACY ONBOARDING REMOVAL
====================================================================
Date: 2026-01-31
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
TASK A: Fixed Apple Sign-In "session expired" bug caused by invalid tokens being stored.
TASK B: Disabled legacy "Get Started Guide" modal; only new interactive onboarding shows.

FILES CHANGED
-------------
1. src/lib/authClient.ts
   - Added isValidBetterAuthToken() validator function (exported)
   - Updated captureAndStoreCookie(): removed substring fallback, validates before store
   - Updated setExplicitCookieValueDirectly(): validates token, returns boolean

2. src/lib/sessionCookie.ts
   - Added isValidSessionToken() local validator (same logic)
   - Updated setExplicitCookiePair(): validates token, returns Promise<boolean>

3. src/app/welcome.tsx
   - Imports isValidBetterAuthToken from authClient
   - Validates tokenValue before storage in Apple Sign-In flow
   - Handles validation failures with user-friendly error

4. src/app/calendar.tsx
   - Disabled checkFirstLogin useEffect (legacy modal trigger)
   - Added one-time migration to set get_started_dismissed flag for all users

KEY DIFFS
---------
authClient.ts:
+ const UUID_PATTERN = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
+ export function isValidBetterAuthToken(token: unknown): { isValid: boolean; reason: string }
+ // REMOVED: fallback logic looking for any key containing 'session_token'
+ // ADDED: validation before storing in captureAndStoreCookie()
+ // CHANGED: setExplicitCookieValueDirectly() returns boolean

sessionCookie.ts:
+ function isValidSessionToken(token: string): { isValid: boolean; reason: string }
+ // CHANGED: setExplicitCookiePair() returns Promise<boolean>

welcome.tsx:
+ import { ..., isValidBetterAuthToken } from "@/lib/authClient";
+ const tokenValidation = isValidBetterAuthToken(tokenValue);
+ if (!tokenValidation.isValid) { throw new Error("...invalid session token..."); }
+ const stored = await setExplicitCookiePair(tokenValue); if (!stored) { throw ... }
+ const cacheSet = setExplicitCookieValueDirectly(...); if (!cacheSet) { throw ... }

calendar.tsx:
- // Old checkFirstLogin logic that showed modal for new users
+ // DISABLED: Legacy first login guide modal
+ // Added one-time migration to set legacy flag as dismissed

RUNTIME STATUS
--------------
npm run typecheck: PASS
bash scripts/ai/verify_frontend.sh: PASS

TEST PLAN
---------
Task A (Apple Login):
1. Build TestFlight with this commit
2. Fresh Apple Sign-In on physical device
3. Complete profile setup (name, photo)
4. Confirm NO "session expired" error appears
5. Confirm /api/auth/session returns 200 (check DEV logs or network inspector)
6. Regression: Email/password login still works

Task B (Legacy Onboarding):
1. Sign in with a fresh account (0 friends, 0 events)
2. Confirm the OLD modal ("Welcome to Open Invite! / Get Started Guide / Maybe later") does NOT appear
3. Confirm the NEW interactive onboarding (if triggered) still works
4. Regression: Settings > "Get Started Guide" still navigates to /onboarding

NOTES / RISKS
-------------
- Token validator rejects any token without a dot - this assumes Better Auth tokens are always signed/JWT-like
- If backend ever returns unsigned tokens, validator will reject them (safe failure mode)
- Legacy modal is disabled but code remains (safe to remove entirely in future cleanup)
- One-time migration sets flag for all users - idempotent, runs on every calendar mount

VALIDATOR REJECTION REASONS
---------------------------
| Reason              | Meaning                           | Action      |
|---------------------|-----------------------------------|-------------|
| empty_or_not_string | Token is null/undefined/not string| Reject      |
| too_short           | Token length < 20 chars           | Reject      |
| uuid_pattern        | Token matches UUID format         | Reject      |
| no_dot_not_signed   | Token has no "." character        | Reject      |
| valid               | Token passes all checks           | Accept      |
