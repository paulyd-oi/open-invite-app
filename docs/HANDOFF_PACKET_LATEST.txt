# HANDOFF: P0 Push Contract Audit & User-Scoped Throttle Fix

**Date:** 2025-01-XX
**Branch:** main  
**Commit:** df4ef03 - fix(push): make token registration throttle key user-scoped [P0_PUSH]
**Status:** COMPLETE - Pushed to main

---

## TASK SUMMARY

Performed P0 Push Notifications End-to-End Contract audit to ensure RSVP/Comment 
notifications are actually delivered. Found and fixed critical bug in token 
registration throttle logic.

---

## AUDIT FINDINGS

### Client Push Pipeline (Mapped)

1. Token Registration: src/lib/push/registerPush.ts -> registerPushToken()
   - Requests permissions via Notifications.getPermissionsAsync() / requestPermissionsAsync()
   - Gets token via Notifications.getExpoPushTokenAsync()
   - Validates with isValidExpoPushToken()
   - POSTs to /api/push/register

2. Push Hook: src/hooks/useNotifications.ts -> useNotifications()
   - Called in _layout.tsx BootRouter when bootStatus === 'authed'
   - Manages registration, listeners, and 24-hour throttle
   - DEV diagnostics via runPushRegistrationProof() and runPushDiagnostics()

3. Logout Deactivation: src/lib/pushTokenManager.ts -> deactivatePushTokenOnLogout()
   - Called from settings.tsx logout flow
   - DELETEs to /api/notifications/unregister-token

4. Token Validation: src/lib/push/validatePushToken.ts -> isValidExpoPushToken()
   - Validates ExponentPushToken[...] format

### Backend Contract Surface (Frontend-Side)

| Endpoint                        | Method | Purpose                |
|---------------------------------|--------|------------------------|
| /api/push/register              | POST   | Register push token    |
| /api/push/me                    | GET    | Verify backend state   |
| /api/notifications/status       | POST   | Update permission status |
| /api/notifications/unregister-token | DELETE | Deactivate on logout |
| /api/notifications/test-push    | POST   | DEV testing            |

### User Actions Triggering Push (Server-Side)

All push sends are server-side after these client actions:
- RSVP: api.post('/api/events/${id}/rsvp', { status })
- Comment: api.post('/api/events/${id}/comments', data)
- Join Request: api.post('/api/events/${id}/join', { message })
- Join Accept/Reject: api.put('/api/events/${id}/join/${requestId}', { status })

### Blast Radius Sweep

sendPush|push|notification: 713 matches
register.*token|pushToken: 11 matches
Notifications.: 62 matches

---

## BUG FOUND & FIXED

### Root Cause

TOKEN_REGISTRATION_KEY was global ("push_token_last_registered"), NOT user-scoped.

Impact:
1. User A logs in, registers push token -> throttle key set with timestamp
2. User A logs out (throttle key NOT cleared)
3. User B logs in within 24 hours
4. User B blocked from registering push token due to shared throttle key
5. User B receives NO push notifications for up to 24 hours

### Fix Applied

File: src/hooks/useNotifications.ts

BEFORE: Global key
const TOKEN_REGISTRATION_KEY = "push_token_last_registered";

AFTER: User-scoped prefix
const TOKEN_REGISTRATION_KEY_PREFIX = "push_token_last_registered:";

const getThrottleKey = (userId: string | undefined): string | null => {
  if (!userId) return null;
  return `${TOKEN_REGISTRATION_KEY_PREFIX}${userId}`;
};

Functions Updated:
1. isRegistrationThrottled(userId) - now user-scoped + [P0_PUSH] logging
2. markTokenRegistered(userId) - now user-scoped + [P0_PUSH] logging  
3. runPushDiagnostics() - two AsyncStorage references now use getThrottleKey()

Diff Size: 1 file, +47/-14 lines

---

## VERIFICATION

- npm run typecheck - PASS
- bash scripts/ai/verify_frontend.sh - PASS
- rg "TOKEN_REGISTRATION_KEY[^_]" src/ - No matches (old constant removed)
- Committed and pushed to main

---

## DEV PROOF LOGS

New [P0_PUSH] logging added for runtime verification:

[P0_PUSH] isRegistrationThrottled: checking key=push_token_last_registered:<userId>
[P0_PUSH] isRegistrationThrottled: lastRegistered=<timestamp>, elapsed=<ms>, throttled=<bool>
[P0_PUSH] markTokenRegistered: setting key=push_token_last_registered:<userId>

---

## WHAT WAS NOT CHANGED

- Backend code (not touched - push sends are server-side, working correctly)
- Token validation logic (already correct)
- Permission request flow (already correct)
- Logout deactivation flow (already correct)
- Notification listener setup (already correct)

---

## FILES TOUCHED

| File                            | Change                                    |
|---------------------------------|-------------------------------------------|
| src/hooks/useNotifications.ts   | User-scoped throttle key + [P0_PUSH] logs |

---

## NEXT STEPS FOR FUTURE SESSIONS

1. Clear old throttle keys on logout (optional enhancement)
   - Could add AsyncStorage.removeItem(getThrottleKey(userId)) to logout flow
   - Not critical since each user now has their own key

2. Backend audit (if push delivery issues persist)
   - Verify /api/push/register stores token correctly per-user
   - Verify push sends in RSVP/Comment handlers fire correctly
   - Check Expo push receipts for delivery failures

3. Runtime verification
   - Test account switching scenario:
     - User A logs in -> registers push -> logs out
     - User B logs in -> should register push immediately
   - Watch for [P0_PUSH] logs in Metro console

---

## END OF HANDOFF
