HANDOFF PACKET — COOKIE AUTH REGRESSION FIX (credentials: "include")
====================================================================
Date: 2026-01-31
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Fixed cookie auth regression where authenticated requests showed "COOKIE HEADER PRESENT false"
in Render logs. After Apple sign-in, GET /api/auth/session was returning 401 missing_token.

ROOT CAUSE:
- authClient.$fetch used credentials: "omit" with manual cookie header injection
- Cookie header format was "; name=value" (with leading semicolon) which is non-standard
- React Native fetch may strip manually-set cookie headers for security

FIX:
1. Changed credentials: "omit" → credentials: "include" in authClient.$fetch
2. Changed cookie header format from "; name=value" → "name=value" (standard format)
3. Changed Apple sign-in POST to use credentials: "include" for cookie jar storage

FILES CHANGED
-------------
1. src/lib/authClient.ts
   - Line ~257: credentials: "omit" → credentials: "include"
   - Line ~240: Cookie header format changed from `; ${explicitCookieValue}` to `${explicitCookieValue}`
   - Moved expo-origin header setup before cookie header for logical grouping
   - Updated comments to reflect new approach

2. src/app/welcome.tsx
   - Line ~583: credentials: "omit" → credentials: "include" for Apple sign-in POST
   - Updated comments to reflect cookie jar usage

KEY DIFFS
---------
authClient.ts $fetch:
- credentials: "omit",
+ credentials: "include",

- finalHeaders.set("cookie", `; ${explicitCookieValue}`);
+ finalHeaders.set("cookie", explicitCookieValue);

welcome.tsx handleAppleSignIn:
- credentials: "omit", // Don't rely on auto cookie handling in RN
+ credentials: "include", // Allow cookie jar to receive Set-Cookie

PROOF EXPECTED (Render logs after deploy)
-----------------------------------------
Before fix:
  [AUTH] COOKIE HEADER PRESENT false | COOKIE LENGTH 0
  GET /api/auth/session 401 missing_token

After fix:
  [AUTH] COOKIE HEADER PRESENT true | COOKIE LENGTH > 0
  GET /api/auth/session 200 (with user data)

TEST PLAN
---------
1. Fresh install app on device
2. Sign in with Apple
3. Observe Render logs for:
   - POST /api/auth/apple 200 (session created)
   - GET /api/auth/session 200 (cookie present)
4. Navigate to calendar - should load without 401 errors
5. Push diagnostics should work (if allowlisted)

VERIFICATION COMMANDS RUN
-------------------------
npm run typecheck                    ✓ PASS (no errors)
bash scripts/ai/verify_frontend.sh  ✓ PASS (all checks)

COMMIT MESSAGE
--------------
fix(auth): restore cookie auth with credentials: "include"

- Change credentials from "omit" to "include" in authClient.$fetch
- Fix cookie header format (remove leading semicolon)
- Update Apple sign-in to use credentials: "include"
- Enables browser/RN cookie jar to store and send session cookies

NEXT STEPS
----------
1. Deploy to TestFlight
2. Test Apple sign-in on physical device
3. Verify Render logs show COOKIE HEADER PRESENT true
4. Verify push notification registration works after auth

REMAINING CONCERNS
------------------
- If RN cookie jar doesn't work cross-origin, may need CORS adjustment on backend
- If still failing, fallback is to add Authorization: Bearer header alongside cookie

calendar.tsx:
- // Old checkFirstLogin logic that showed modal for new users
+ // DISABLED: Legacy first login guide modal
+ // Added one-time migration to set legacy flag as dismissed

RUNTIME STATUS
--------------
npm run typecheck: PASS
bash scripts/ai/verify_frontend.sh: PASS

TEST PLAN
---------
Task A (Apple Login):
1. Build TestFlight with this commit
2. Fresh Apple Sign-In on physical device
3. Complete profile setup (name, photo)
4. Confirm NO "session expired" error appears
5. Confirm /api/auth/session returns 200 (check DEV logs or network inspector)
6. Regression: Email/password login still works

Task B (Legacy Onboarding):
1. Sign in with a fresh account (0 friends, 0 events)
2. Confirm the OLD modal ("Welcome to Open Invite! / Get Started Guide / Maybe later") does NOT appear
3. Confirm the NEW interactive onboarding (if triggered) still works
4. Regression: Settings > "Get Started Guide" still navigates to /onboarding

NOTES / RISKS
-------------
- Token validator rejects any token without a dot - this assumes Better Auth tokens are always signed/JWT-like
- If backend ever returns unsigned tokens, validator will reject them (safe failure mode)
- Legacy modal is disabled but code remains (safe to remove entirely in future cleanup)
- One-time migration sets flag for all users - idempotent, runs on every calendar mount

VALIDATOR REJECTION REASONS
---------------------------
| Reason              | Meaning                           | Action      |
|---------------------|-----------------------------------|-------------|
| empty_or_not_string | Token is null/undefined/not string| Reject      |
| too_short           | Token length < 20 chars           | Reject      |
| uuid_pattern        | Token matches UUID format         | Reject      |
| no_dot_not_signed   | Token has no "." character        | Reject      |
| valid               | Token passes all checks           | Accept      |
