HANDOFF PACKET — PUSH TOKEN REGISTRATION COMPLETE
==================================================
Date: 2025-01-31
Branch: main
Commit: 6989ad5
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Complete push token registration implementation with:
1. Single source-of-truth validator (src/lib/push/validatePushToken.ts)
2. All registration paths use /api/push/register (NOT /api/notifications/register-token)
3. DEV-only proof diagnostics [PUSH_PROOF] and [NUDGE_PROOF]
4. Correct projectId resolution order
5. Registration on boot (authed), app foreground (throttled), and nudge modal grant

ROOT CAUSE FIXED
----------------
Backend was receiving placeholder tokens like ExponentPushToken[test123].
Now: Tokens validated before registration, invalid tokens rejected with DEV logs.

FILES + KEY IMPLEMENTATION
--------------------------
1. src/lib/push/validatePushToken.ts (SINGLE SOURCE OF TRUTH)
   - isValidExpoPushToken(token): rejects test/mock/placeholder/fake/dummy/sample
   - getTokenPrefix(token): safe 24-char prefix for logging

2. src/hooks/useNotifications.ts
   - runPushRegistrationProof(): DEV-only cold start diagnostic
   - checkAndRegisterToken(): validates then POSTs to /api/push/register
   - AppState.active re-registers (24h throttle)
   - Uses: Constants.easConfig?.projectId ?? Constants.expoConfig?.extra?.eas?.projectId

3. src/components/notifications/NotificationNudgeModal.tsx
   - registerPushTokenWithBackend(): called after permission grant
   - Full [NUDGE_PROOF] logging with GET /api/push/me verification

4. src/lib/push/registerPush.ts
   - Uses shared validator
   - POSTs to /api/push/register

REGISTRATION ENDPOINT
---------------------
POST /api/push/register
Body: { "token": "ExponentPushToken[...]", "platform": "expo" }
Auth: Cookie-based via authClient.$fetch (lowercase "cookie" header)

RUNTIME STATUS
--------------
✓ TypeCheck: PASS
✓ verify_frontend.sh: PASS
✓ No /api/notifications/register-token in src/**

DEV PROOF LOGS (EXPECTED ON PHYSICAL DEVICE)
--------------------------------------------
[PUSH_PROOF] ========== PUSH REGISTRATION PROOF START ==========
[PUSH_PROOF] 1. isPhysicalDevice: true
[PUSH_PROOF] 2. permissionStatus: granted
[PUSH_PROOF] 3. projectId: <UUID>
[PUSH_PROOF] 4. Fetching Expo push token...
[PUSH_PROOF]    tokenPrefix: ExponentPushToken[REAL...
[PUSH_PROOF]    tokenLength: 44
[PUSH_PROOF] 5. isValidExpoPushToken: true
[PUSH_PROOF] 6. POST /api/push/register ...
[PUSH_PROOF]    POST status: 200
[PUSH_PROOF]    POST body: {"ok":true}
[PUSH_PROOF] 7. GET /api/push/me ...
[PUSH_PROOF]    GET status: 200
[PUSH_PROOF]    GET body: {"tokens":[{"tokenPrefix":"ExponentPushToken[REAL...","isActive":true}]}
[PUSH_PROOF]    ✅ Token found and isActive=true
[PUSH_PROOF] ========== PUSH REGISTRATION PROOF END ==========

FAILURE SCENARIOS
-----------------
| Symptom                    | Meaning                        | Fix                          |
|----------------------------|--------------------------------|------------------------------|
| isPhysicalDevice: false    | Simulator                      | Use physical device          |
| permissionStatus: denied   | User denied notifications      | Trigger nudge modal          |
| projectId: NOT_FOUND       | Missing EAS config             | Check app.json/eas.json      |
| isValidExpoPushToken: false| Placeholder/test token         | Must be real device          |
| POST 401 UNAUTHORIZED      | Auth cookie missing            | Check login state            |
| GET tokens: []             | Backend didn't persist         | Check backend route handler  |

HOW TO VERIFY ON PHYSICAL DEVICE
--------------------------------
1. Build: eas build --platform ios --profile production
2. Install on physical iPhone
3. Sign in
4. Look for [PUSH_PROOF] logs in Xcode console
5. Expected: POST 200, GET shows isActive=true

BACKEND VERIFICATION
--------------------
curl -c /tmp/oi.txt -b /tmp/oi.txt \
  -X POST https://open-invite-api.onrender.com/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"EMAIL","password":"PASS"}'

curl -b /tmp/oi.txt https://open-invite-api.onrender.com/api/push/me

Expected: tokenPrefix NOT "test123", isActive = true

REMAINING RISKS
---------------
1. If backend /api/push/register handler doesn't upsert correctly, tokens won't persist
2. If auth cookie not attached, POST returns 401 (check authClient)
3. Simulators will always fail (by design - no real APNs token)

WHAT TO TEST IN TESTFLIGHT
--------------------------
1. Fresh install → sign in → permission grant → [PUSH_PROOF] logs show success
2. App foreground → should not re-register (24h throttle) unless forced
3. Nudge modal → grant → [NUDGE_PROOF] logs show success
4. curl /api/push/me → tokenPrefix is REAL token, isActive=true
