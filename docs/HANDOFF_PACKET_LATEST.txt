========================================
HANDOFF PACKET - Apple Sign-In Trace Logging
Date: 2026-01-30
Commit: 32d289e
========================================

SUMMARY
-------
Added comprehensive DEV-only trace logging and debug panel for Apple Sign-In
to diagnose "apple sign in encountered an issue" failures.

FILES CHANGED
-------------
src/app/welcome.tsx
  - handleAppleSignIn function instrumented with [APPLE_AUTH_TRACE]
  - Added appleAuthDebug state for tracking last attempt
  - Added DEV-only debug panel on iOS in Slide 2 (auth screen)

CONFIG AUDIT
------------
app.json iOS config verified:
  - bundleIdentifier: com.vibecode.openinvite.0qi5wk
  - usesAppleSignIn: true (required for native capability)
  - jsEngine: jsc

expo-apple-authentication:
  - Dynamically loaded via require() in welcome.tsx
  - Availability checked via isAppleSignInAvailable() helper

LOG TAGS AND STAGES
-------------------
All logs are JSON lines with tag [APPLE_AUTH_TRACE] and unique attemptId.

Stages in order:
1. tap - Button pressed
2. availability_check - Platform module isAppleSignInReady
3. availability_fail - If checks fail
4. request_start - signInAsync called
5. request_result - Credential received (tokens redacted)
6. credential_invalid - If identityToken missing
7. backend_exchange_start - Fetch to /api/auth/apple
8. backend_exchange_response - HTTP status body preview
9. backend_exchange_fail - If not response.ok
10. token_extraction - Which token field used
11. token_missing - If no token found
12. cookie_persist_securestore - SecureStore write
13. cookie_persist_securestore_fail - If write fails
14. cookie_cache_set - Module cache set
15. cookie_cache_verified - Refresh success
16. bootstrap_refresh_requested - Boot refresh triggered
17. final_success - Advancing to slide 3
18. user_cancelled - User cancelled
19. final_fail - Error with full object

DEV DEBUG PANEL
---------------
Shows on Slide 2 when attemptId exists:
- Dark background with monospace text
- Displays attemptId stage error

HOW TO REPRODUCE
----------------
1. Build DEV: eas build --profile development --platform ios
2. Install on physical iOS device
3. Navigate to Slide 2 Create Account
4. Tap Continue with Apple
5. Watch debug panel and console for traces
6. Check logs: npx react-native log-ios

FAILURE INTERPRETATION
----------------------
availability_fail: Module not loaded
request_start then final_fail: Native sheet failed
backend_exchange_fail: Backend rejected token
token_missing: No token in response
cookie_persist_securestore_fail: SecureStore write failed

VERIFICATION RESULTS
--------------------
npm run typecheck: PASS
bash scripts/ai/verify_frontend.sh: PASS

GIT
---
Commit: 32d289e fix(auth): add Apple Sign-In trace logging
Push: a085a00..32d289e main

========================================
END HANDOFF
========================================
