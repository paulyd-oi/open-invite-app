HANDOFF PACKET â€” APPLE AUTH ORIGIN + AUTHCODE FIX
====================================================================
Date: 2026-02-01
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Updated Apple Sign-In backend exchange to match cookie/trusted-origin
behavior used by email sign-in:
  - Added Origin: "open-invite://" header
  - Added authorizationCode to JSON body (alongside identityToken)
  - Kept credentials: "include"

FILES CHANGED
-------------
1. src/app/welcome.tsx
   - handleAppleSignIn fetch() call updated

KEY DIFF
--------
  const response = await fetch(backendUrl, {
    method: "POST",
-   headers: { "Content-Type": "application/json" },
+   headers: {
+     "Content-Type": "application/json",
+     "Origin": "open-invite://",
+   },
    credentials: "include",
    body: JSON.stringify({
      identityToken: credential.identityToken,
+     authorizationCode: credential.authorizationCode,
      user: { ... },
    }),
  });

RUNTIME STATUS
--------------
npm run typecheck                    PASS

HOW TO VERIFY ON-DEVICE
-----------------------
1. Delete app from physical iPhone
2. Fresh install from TestFlight
3. Apple Sign-In
4. Check device logs for APPLE_AUTH_TRACE stages:
   - [APPLE_AUTH_TRACE] apple_auth_start
   - [APPLE_AUTH_TRACE] apple_credential_received
   - [APPLE_AUTH_TRACE] apple_auth_backend_start { url, method: "POST" }
   - [APPLE_AUTH_TRACE] apple_auth_backend_response { status: 200, ok: true, hasToken: true }
   - [APPLE_AUTH_TRACE] token_stored_success
   - [AUTH_BARRIER_RESULT] ok=true status=200 userId=...

5. Check Render backend logs for:
   - Origin header present: "open-invite://"
   - authorizationCode present in request body
   - Session cookie set in response

6. Subsequent authed calls should show:
   - [AUTH_HDR] x-oi-session-token len=N hadCookie=true
   - No 401 errors

CONSTRAINTS MET
---------------
- Minimal diff (1 file, ~5 lines changed)
- No new dependencies
- Expo + RN + Expo Router only
- Icon system untouched
- Navigation architecture preserved
