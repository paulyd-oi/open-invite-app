HANDOFF PACKET — PUSH REGISTER ROUTE FIX
========================================
Date: 2025-01-31
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Changed push token registration endpoint from /api/notifications/register-token 
to /api/push/register (the route that actually upserts push_token rows).
Added DEV logs with route used and tokenPrefix for proof.

ROOT CAUSE
----------
Frontend was posting to /api/notifications/register-token which may not be the
endpoint that actually creates/updates rows in the push_token table.
Backend expects POST /api/push/register with JSON { token, platform }.

CHANGES
-------
1. UPDATED: src/hooks/useNotifications.ts
   - Line 138: POST /api/push/register (was /api/notifications/register-token)
   - Line 146: DEV log shows route + tokenPrefix

2. UPDATED: src/hooks/useNotifications.ts (diagnoseAndFixPush)
   - Line 414: POST /api/push/register (was /api/notifications/register-token)
   - Line 418: DEV log shows route + tokenPrefix

3. UPDATED: src/components/notifications/NotificationNudgeModal.tsx
   - Line 72: POST /api/push/register (was /api/notifications/register-token)
   - Line 77: DEV log shows route + tokenPrefix

4. UPDATED: src/lib/push/registerPush.ts
   - Line 193: POST /api/push/register (was /api/notifications/register-token)
   - Line 203: DEV log shows route + tokenPrefix

FILES CHANGED
-------------
src/hooks/useNotifications.ts (2 endpoint changes + logs)
src/components/notifications/NotificationNudgeModal.tsx (1 endpoint change + log)
src/lib/push/registerPush.ts (1 endpoint change + log)

RUNTIME STATUS
--------------
✓ TypeCheck: PASS (pre-existing errors in EmailVerificationBanner unrelated)
✓ verify_frontend.sh: PASS

CODE PATH PROOF
---------------
Registration endpoint: POST /api/push/register

EXACT FILE/LINE WHERE POST HAPPENS:
1. src/hooks/useNotifications.ts:138-142
   const PUSH_REGISTER_ROUTE = "/api/push/register";
   await api.post(PUSH_REGISTER_ROUTE, { token, platform: "expo" });
   
2. src/hooks/useNotifications.ts:414-418 (diagnoseAndFixPush)
   const PUSH_REGISTER_ROUTE = "/api/push/register";
   await api.post(PUSH_REGISTER_ROUTE, { token, platform: "expo" });
   
3. src/components/notifications/NotificationNudgeModal.tsx:72-76
   const PUSH_REGISTER_ROUTE = "/api/push/register";
   await api.post(PUSH_REGISTER_ROUTE, { token, platform: "expo" });
   
4. src/lib/push/registerPush.ts:193-197
   const PUSH_REGISTER_ROUTE = "/api/push/register";
   await api.post(PUSH_REGISTER_ROUTE, { token, platform: "expo" });

REQUEST BODY:
{ "token": "ExponentPushToken[...]", "platform": "expo" }

AUTH:
api.post uses authClient.$fetch which sets lowercase "cookie" header
with session cookie (credentials handled manually for React Native).

DEV LOG LINES (real device)
---------------------------
At boot (permission already granted):
[PUSH_BOOTSTRAP] Got valid token: ExponentPushToken[abc12...
[PUSH_BOOTSTRAP] ✓ Token registered | route=/api/push/register | tokenPrefix=ExponentPushToken[abc12...

Via nudge modal (after permission grant):
[NotificationNudge] ✓ Token registered | route=/api/push/register | tokenPrefix=ExponentPushToken[abc12...

Via diagnoseAndFixPush:
[PUSH_DIAG] registering_token route=/api/push/register
[PUSH_DIAG] ✓ token_registered | route=/api/push/register | tokenPrefix=ExponentPushToken[abc12...

Via registerPush.ts (if called):
[registerPush] ✓ Token registered | route=/api/push/register | tokenPrefix=ExponentPushToken[abc12...

VERIFICATION COMMANDS
---------------------
# After TestFlight install:

# 1. Login
curl -c /tmp/oi_cookies.txt -b /tmp/oi_cookies.txt \
  -X POST https://open-invite-api.onrender.com/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"YOUR_EMAIL","password":"YOUR_PASS"}'

# 2. Check tokens
curl -b /tmp/oi_cookies.txt \
  https://open-invite-api.onrender.com/api/push/me

# Expected:
# - tokenPrefix NOT containing "test123"
# - isActive = true

HOW TO VERIFY ON DEVICE
-----------------------
1. Build TestFlight: eas build --platform ios --profile production
2. Install on physical iPhone
3. Open app, sign in
4. Either:
   a) Permission already granted → auto-registers on boot
   b) Permission not granted → nudge modal appears → tap Enable → registers
5. Check Xcode console for log lines containing "route=/api/push/register"
6. Verify backend via curl /api/push/me

IDEMPOTENCY
-----------
- useNotifications throttles registration to once per 24 hours (AsyncStorage key)
- Backend upserts tokens, so duplicate calls are safe
- AppState.active triggers re-check but throttle prevents spam

WHAT TO DO NEXT
---------------
Build and test on physical iPhone to confirm real token registration via /api/push/register.
