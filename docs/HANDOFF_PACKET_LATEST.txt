HANDOFF PACKET: Build 231 Trust Regressions + Structural Invariants (Final)
============================================================================
Date: 2026-02-02
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Completed all Build 231 trust regressions. Change Color now available on ALL events
(no legacy gating). Private/busy events properly guard navigation and show friendly
UX messages. TypeScript passes. Ready for QA verification.

P0 FIXES (TRUST/DATA)
---------------------

1. Settings Subscription Block Never Blank
   File: src/app/settings.tsx (~line 1815)
   Issue: During loading, subscription section showed blank text "Loading..."
   Fix: Always render a meaningful state. During loading, show "loading_default_free"
        which renders the Free tier card. Pro state shown once entitlements resolve.
   Invariant: Subscription section ALWAYS renders a card (Free or Pro), never blank.

2. Busy/Private Events Hide Titles + Disable Navigation
   File: src/components/FeedCalendar.tsx (EventListItem)
   Issue: Friend's busy/private events leaked real titles in day modal
   Fix: Added `isNonVisible` check for events where user doesn't own and (isBusy || isPrivate)
        - Title: Shows "Busy" with ðŸ”’ emoji
        - Navigation: Disabled (onPress does nothing)
        - Location/Host: Hidden entirely
   Invariant: Non-own busy/private events NEVER leak title, location, or host data.

3. Notification Permission Real-State Driven
   Files: src/app/activity.tsx, src/app/notification-settings.tsx
   Issue: Notification toggle showed ON even when OS permission denied
   Fix (activity.tsx): On first tab open, check permission status. If "undetermined",
        prompt user. Track with AsyncStorage to avoid repeated prompts.
   Fix (notification-settings.tsx): Added `osPermissionStatus` state tracking. 
        On screen focus, check OS status. Master toggle = backend && OS granted.
        If user enables toggle while OS denied, request permission first.
   Invariant: Push toggle reflects ACTUAL OS permission state, not just backend pref.

4. Event Not Found â†’ Private/Busy Safety Net
   Files: src/app/event/[id].tsx, src/app/event/edit/[id].tsx
   Issue: 403/404 errors showed "Event not found" which exposes route structure
   Fix: Replaced with friendly UX:
        - Title: "This time is blocked"
        - Body: "This event is private, or you're marked as busy at this time."
        - Go Back button (no route strings exposed)
   Invariant: 403/404 on event detail = non-visible state, NOT "missing" state.

P1 FIXES (UX POLISH)
--------------------

5. Suggestions Cards: @username + Bio + Muted Mutual Friends
   File: src/app/suggestions.tsx (SuggestionCard)
   Issue: Cards showed only display name, no @handle or bio
   Fix: Now displays:
        - Display name (bold)
        - @username below name (textSecondary)
        - Bio/calendarBio if available (textTertiary, 1 line)
        - "N mutual friends" text (textTertiary, muted)
        - Removed cluttered mutual friend avatar stack
   
6. Change Color Available on ALL Events
   File: src/app/calendar.tsx (~line 862)
   Issue: "Change Color" context menu had legacy gating (isOwner, group-tied)
   Fix: Removed ALL gates. Change Color now appears for:
        - Own events
        - Friend events
        - Circle events
        - ANY event with long-press context menu
   Doctrine: Color is viewer-local cosmetic only, no backend write needed.
   Invariant: Change Color available on EVERY event card that supports long-press.

VERIFICATION
------------
âœ… yarn typecheck PASS
âœ… bash scripts/ai/verify_frontend.sh PASS

QA CHECKLIST
------------
[ ] Settings screen: Subscription block shows Free/Pro, never blank
[ ] Day modal: Long-press friend's busy event â†’ shows "ðŸ”’ Busy", no navigation
[ ] Activity tab first open: Prompts for notification permission if undetermined
[ ] Notification settings: Toggle reflects actual OS permission status
[ ] Suggestions cards: Show @username and bio when available
[ ] Calendar: Long-press ANY event â†’ "Change Color" option appears
[ ] Navigate to non-visible event â†’ "This time is blocked" message, Go Back button

FILES MODIFIED
--------------
- src/app/settings.tsx (subscription block loading state)
- src/components/FeedCalendar.tsx (EventListItem busy/private handling)
- src/app/activity.tsx (first-open permission request)
- src/app/notification-settings.tsx (OS permission state sync)
- src/app/suggestions.tsx (SuggestionCard @username + bio)
- src/app/calendar.tsx (Change Color ungated - available everywhere)
- src/app/event/[id].tsx (private/busy UX message)
- src/app/event/edit/[id].tsx (private/busy UX message)
- src/app/calendar.tsx (Change Color ungated from isOwner)
