HANDOFF PACKET â€” APPLE SESSION TOKEN FIX
====================================================================
Date: 2026-02-01
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Fixed Apple Sign-In so that after POST /api/auth/apple returns { token },
every subsequent request includes x-oi-session-token header and
/api/auth/session returns 200.

KEY CHANGES
-----------
1. clearOiSessionToken() now sets oiSessionTokenInitialized = true
   - Prevents rehydrating stale values after sign out
   - setOiSessionToken() already correctly sets memory + initialized flag

2. welcome.tsx now uses ensureSessionReady() for session barrier
   - Replaces inline barrier with proper function call
   - Logs AUTH_BARRIER_RESULT with ok/status/userId/attempt
   - Throws and does NOT proceed silently if barrier fails

FILES CHANGED
-------------
1. src/lib/authClient.ts
   - clearOiSessionToken(): Added oiSessionTokenInitialized = true

2. src/app/welcome.tsx
   - Added ensureSessionReady to imports
   - Replaced inline cookie barrier with ensureSessionReady() call
   - Added AUTH_BARRIER_RESULT log line

PROOF LOGS (Expected on Device)
-------------------------------
After Apple Sign-In:
  [OI_TOKEN] stored len=N
  [AUTH_BARRIER] ok=true status=200 userId=abc12345... attempt=1
  [AUTH_BARRIER_RESULT] ok=true status=200 userId=abc12345... attempt=1
  [APPLE_TOKEN_PROOF] tokenFound=true tokenLen=N barrier200=true userIdPresent=true

Subsequent authed calls (e.g., /api/app-config or /api/push/me):
  [AUTH_HDR] x-oi-session-token len=N hadCookie=true
  (No 401 errors)

TEST PLAN
---------
1. Delete app from physical iPhone
2. Fresh install from TestFlight
3. Apple Sign-In
4. Check device logs for:
   - [OI_TOKEN] stored len=N (token persisted)
   - [AUTH_BARRIER_RESULT] ok=true status=200 userId=... attempt=1
   - [APPLE_TOKEN_PROOF] tokenFound=true tokenLen=N barrier200=true userIdPresent=true
5. Navigate through app - confirm no 401 errors
6. Check Render logs for x-oi-session-token header presence

VERIFICATION
------------
npm run typecheck                    PASS
git status --porcelain              (clean after commit)

CONSTRAINTS
-----------
- Minimal diff (2 files, less than 20 lines changed)
- No new dependencies
- Icon system untouched
- Navigation architecture preserved
