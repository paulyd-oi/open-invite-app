HANDOFF PACKET â€” PUSH TOKEN REGISTRATION FIX
=============================================
Date: 2025-01-31
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Fixed push notification token registration to reject placeholder tokens
and properly register real device tokens with backend.

ROOT CAUSE
----------
Backend showed: GET /api/push/me
  tokens[0].tokenPrefix = "ExponentPushToken[test123]"
  tokens[0].isActive = false

This indicates a placeholder token was registered at some point.
The app had validation in useNotifications.ts but NOT in:
- registerPush.ts (unguarded registration path)
- NotificationNudgeModal.tsx (no registration after permission grant)

FIX APPLIED
-----------
1. Added isValidPushToken() validation to registerPush.ts
   - Rejects tokens containing 'test', 'placeholder', 'mock'
   - Rejects tokens shorter than 30 chars
   - Only accepts valid ExponentPushToken/ExpoPushToken prefixes

2. Fixed projectId lookup order in registerPush.ts and notifications.ts
   - BEFORE: Constants.expoConfig.extra.eas.projectId ?? Constants.easConfig.projectId
   - AFTER:  Constants.easConfig.projectId ?? Constants.expoConfig.extra.eas.projectId
   - Prefers eas.json projectId which is the correct source

3. Added token registration to NotificationNudgeModal.tsx
   - When user grants permission via nudge modal, token is now registered
   - Previously only updated permission status, never registered token
   - Added registerPushTokenWithBackend() function with full validation

FILES CHANGED
-------------
src/lib/push/registerPush.ts
  - Added isValidPushToken() validation function
  - Fixed projectId lookup order
  - Added validation before backend registration

src/lib/notifications.ts
  - Fixed projectId lookup order
  - Truncated token in DEV log output

src/components/notifications/NotificationNudgeModal.tsx
  - Added Device and Constants imports
  - Added isValidPushToken() and registerPushTokenWithBackend()
  - Call registerPushTokenWithBackend() after permission granted

RUNTIME STATUS
--------------
TypeCheck: PASS
verify_frontend.sh: PASS

KEY VALIDATION LOGIC
--------------------
function isValidPushToken(token: string): boolean {
  if (!token || typeof token !== 'string') return false;
  if (!token.startsWith("ExponentPushToken[") && 
      !token.startsWith("ExpoPushToken[") && 
      !token.startsWith("ExpoToken[")) return false;
  const lowerToken = token.toLowerCase();
  if (lowerToken.includes('test') || 
      lowerToken.includes('placeholder') || 
      lowerToken.includes('mock')) return false;
  if (token.length < 30) return false;
  return true;
}

DEV LOG LINES TO EXPECT (on real device)
----------------------------------------
[NotificationNudge] Got token: ExponentPushToken[abc1...
[NotificationNudge] Token registered successfully
-- OR --
[PUSH_BOOTSTRAP] Got valid token: ExponentPushToken[abc1...
[PUSH_BOOTSTRAP] Token registered with /api/notifications/register-token

PROOF COMMANDS (after TestFlight build)
---------------------------------------
# 1. Login and get cookie
curl -c /tmp/oi_cookies.txt -b /tmp/oi_cookies.txt \
  -X POST https://open-invite-api.onrender.com/api/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{"email":"YOUR_EMAIL","password":"YOUR_PASS"}'

# 2. Check push tokens
curl -b /tmp/oi_cookies.txt \
  https://open-invite-api.onrender.com/api/push/me

# Expected: tokenPrefix starts with ExponentPushToken[ and NOT test123
# Expected: isActive=true for the real device token

WHAT TO DO NEXT
---------------
1. Build new TestFlight release (eas build --platform ios --profile production)
2. Install on physical iPhone
3. Open app and grant notification permission when nudge modal appears
4. Check Xcode console for "[NotificationNudge] Token registered successfully"
5. Verify via curl /api/push/me that tokenPrefix is real and isActive=true
6. Test receiving a push notification

INVARIANTS PRESERVED
--------------------
- No new dependencies added
- Uses existing expo-notifications, expo-device, expo-constants
- Better Auth cookie-based auth (credentials: "include")
- All token validation uses consistent isValidPushToken() logic
