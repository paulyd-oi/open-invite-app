========================================
HANDOFF PACKET - Push Notification Registration Fix
========================================
Date: 2025-01-29
Branch: main
Author: GitHub Copilot (Claude Opus 4.5)

========================================
SUMMARY
========================================
Fixed push notification token registration to properly gate on
bootStatus === 'authed' instead of just checking session?.user.
This ensures:
1. No network calls fire when logged out
2. Token registration only happens once properly authenticated
3. Permission status updates are sent to backend
4. Comprehensive DEV logging for debugging

========================================
FILES CHANGED
========================================
src/hooks/useNotifications.ts
  - Added import: useBootAuthority from @/hooks/useBootAuthority
  - Added bootStatus gating in checkAndRegisterToken()
  - Added bootStatus gating in initial registration effect
  - Added registrationAttempted ref to track state
  - Added [PUSH_BOOTSTRAP] DEV logs for tracing
  - Updated effect dependency array to include bootStatus

========================================
KEY DIFFS
========================================
1. Added bootStatus check in checkAndRegisterToken:
   if (bootStatus !== 'authed' || !session?.user) {
     if (__DEV__) {
       console.log("[useNotifications] Skipping registration - bootStatus:", bootStatus);
     }
     return;
   }

2. Added bootStatus check in initial registration effect:
   useEffect(() => {
     if (bootStatus !== 'authed' || !session?.user) {
       return;
     }
     // ... registration logic
   }, [bootStatus, session?.user?.id, checkAndRegisterToken]);

3. Added comprehensive DEV logging:
   [PUSH_BOOTSTRAP] Boot complete, initiating push registration
   [PUSH_BOOTSTRAP] Permission status: granted/denied
   [PUSH_BOOTSTRAP] Registering push token with backend...
   [PUSH_BOOTSTRAP] Got token: ExponentPushToken[xxx]...
   [PUSH_BOOTSTRAP] Token registered successfully
   [PUSH_BOOTSTRAP] Push registration complete

========================================
VERIFICATION
========================================
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS
- AUTH_CONTRACT.md exists
- No !!session gating found
- No uppercase Cookie headers
- Guidance keys user-scoped
- Invariant check PASSED

========================================
PROOF (REQUIRES TESTFLIGHT BUILD)
========================================
After deploying TestFlight build, verify with backend commands:

1. Check device tokens:
   GET /api/notifications/device-tokens
   Expected: { activeCount: >= 1 }

2. Check user notification snapshot:
   GET /api/notifications/snapshot?userId=<USER_ID>
   Expected: { pushPermissionStatus: "granted", tokens: { active: >= 1 } }

3. Test push delivery:
   POST /api/notifications/test-push
   Body: { userId: "<USER_ID>" }
   Expected: { success: true }

4. Console log proof (DEV build):
   [PUSH_BOOTSTRAP] Boot complete, initiating push registration
   [PUSH_BOOTSTRAP] Permission status: granted
   [PUSH_BOOTSTRAP] Registering push token with backend...
   [PUSH_BOOTSTRAP] Got token: ExponentPushToken[...]
   [PUSH_BOOTSTRAP] Token registered successfully
   [PUSH_BOOTSTRAP] Push registration complete

========================================
NEXT STEPS
========================================
1. Build TestFlight: Run shipios (scripts/ship-ios-prod.sh)
2. Install on real device
3. Grant notification permission when prompted
4. Verify backend shows:
   - pushPermissionStatus = "granted"
   - activeCount >= 1 in device-tokens
5. Send test push and confirm delivery

========================================
INVARIANTS PRESERVED
========================================
- No new dependencies added
- expo-notifications already installed
- bootStatus gating pattern matches existing hooks
- Auth contract preserved (cookie-based auth)
- Minimal diff (single file, surgical changes)

========================================
END OF HANDOFF
========================================
