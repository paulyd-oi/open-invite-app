# HANDOFF: P0 Push Token Binding SSOT + Backend Verify

**Date:** 2026-02-03
**Branch:** main
**Commit:** effb24e - fix(p0): push token binding SSOT + backend verify
**Status:** COMPLETE - Pushed to main

---

## TASK SUMMARY

Guarantee that every authenticated session reliably registers a push token to the
backend for the correct user, and that account switching re-registers immediately.
Added deterministic proof using backend /api/push/me endpoint.

---

## ROOT CAUSE (Why NO_ACTIVE_TOKENS happened)

Backend logs showed:
```
[P0_PUSH_SEND] SKIP ... reason=NO_ACTIVE_TOKENS
```

Causes identified:
1. **Throttle masking empty backend**: Client throttled registration for 24h, but backend
   had 0 active tokens (previous token deactivated or never registered)
2. **No verification**: After POST /api/push/register, we never verified backend state
3. **Account switch ignored throttle**: Logging in as different user within throttle window
   reused old throttle key state (already fixed in prior task with user-scoped keys, but
   no bypass if backend empty)

---

## FIX SUMMARY

### 1. verifyPushMe() Helper
Added helper function to call GET /api/push/me and return:
- activeCount: number of active tokens
- totalCount: total tokens
- lastSeenAt: latest active token's lastSeenAt

### 2. Throttle Bypass When Backend Empty (KEY FIX)
```
if throttled:
  backendState = await verifyPushMe()
  if backendState.activeCount === 0:
    BYPASS THROTTLE → force register
```
This prevents stale throttle from masking missing tokens.

### 3. Account Switch Detection
Track `lastRegisteredUserId` module variable. When userId changes:
- Log as isAccountSwitch=true
- Bypass throttle regardless

### 4. Backend Verification After Registration
After successful POST /api/push/register, immediately call verifyPushMe() and log:
```
[P0_PUSH_REG] VERIFY_BACKEND userId=abc123... activeCount=1 totalCount=1 lastSeenAt=...
```

### 5. Canonical [P0_PUSH_REG] Logs ONLY
Replaced all non-canonical log tags:
- [PUSH_BOOTSTRAP] → [P0_PUSH_REG]
- [P0_PUSH] → [P0_PUSH_REG]

---

## FILES CHANGED

| File | Change |
|------|--------|
| src/hooks/useNotifications.ts | +verifyPushMe(), throttle bypass, canonical logs, account switch |

---

## AUDITED CALLSITE LIST

### Push Registration Entrypoints

| File | Function | Purpose | Status |
|------|----------|---------|--------|
| src/hooks/useNotifications.ts | checkAndRegisterToken() | Boot-time + foreground registration | CANONICAL ✅ |
| src/hooks/useNotifications.ts | useEffect (bootStatus) | Triggers on authed + userId change | Updated ✅ |
| src/lib/push/registerPush.ts | registerPushToken() | Standalone registration | Called by NudgeModal |
| src/components/notifications/NotificationNudgeModal.tsx | registerPushTokenWithBackend() | User-initiated via modal | Separate flow |

### useNotifications() Callsites

| File:Line | Context |
|-----------|---------|
| src/app/_layout.tsx:234 | Global registration on boot |
| src/app/settings.tsx:383 | Diagnostics access |

---

## EXAMPLE LOGS

### Normal Registration (Not Throttled)
```
[P0_PUSH_REG] BOOT_AUTHED userId=abc12345... isAccountSwitch=false lastUser=null
[P0_PUSH_REG] PERMISSION_CHECK userId=abc12345... status=granted
[P0_PUSH_REG] THROTTLE_CHECK userId=abc12345... result=false (no timestamp)
[P0_PUSH_REG] ATTEMPT userId=abc12345... force=false permChange=false accountSwitch=false throttleBypass=none
[P0_PUSH_REG] TOKEN_VALID userId=abc12345... tokenSuffix=xyz789
[P0_PUSH_REG] REGISTER_SUCCESS userId=abc12345... attempt=1 tokenSuffix=xyz789
[P0_PUSH_REG] THROTTLE_MARKED userId=abc12345...
[P0_PUSH_REG] VERIFY_BACKEND userId=abc12345... activeCount=1 totalCount=1 lastSeenAt=2026-02-03T14:42:29.000Z
[P0_PUSH_REG] ✓ COMPLETE userId=abc12345... success=true activeCount=1
```

### Throttle Bypass (Backend Empty)
```
[P0_PUSH_REG] BOOT_AUTHED userId=def67890... isAccountSwitch=false lastUser=abc12345
[P0_PUSH_REG] PERMISSION_CHECK userId=def67890... status=granted
[P0_PUSH_REG] THROTTLE_CHECK userId=def67890... elapsed=3600s result=true
[P0_PUSH_REG] THROTTLED userId=def67890... checking backend state...
[P0_PUSH_REG] THROTTLE_BYPASS reason=BACKEND_EMPTY userId=def67890... activeCount=0 totalCount=2
[P0_PUSH_REG] ATTEMPT userId=def67890... force=false permChange=false accountSwitch=false throttleBypass=BACKEND_EMPTY
... (registration continues)
```

### Account Switch
```
[P0_PUSH_REG] BOOT_AUTHED userId=newuser00... isAccountSwitch=true lastUser=olduser00
[P0_PUSH_REG] PERMISSION_CHECK userId=newuser00... status=granted
[P0_PUSH_REG] ATTEMPT userId=newuser00... force=false permChange=false accountSwitch=true throttleBypass=none
... (registration continues)
```

### Permission Denied
```
[P0_PUSH_REG] BOOT_AUTHED userId=abc12345... isAccountSwitch=false lastUser=null
[P0_PUSH_REG] PERMISSION_CHECK userId=abc12345... status=denied
[P0_PUSH_REG] SKIP reason=PERMISSION_DENIED userId=abc12345...
```

---

## MANUAL REPRO STEPS

### 1. User A Login → Verify activeCount >= 1
1. Fresh install or clear app data
2. Login as User A
3. Grant push permission when prompted
4. Check console for: `[P0_PUSH_REG] ✓ COMPLETE ... activeCount=1`
5. Verify: GET /api/push/me shows activeCount >= 1

### 2. Logout → User B Login Within 24h → Verify activeCount >= 1
1. Logout User A
2. Login as User B (different account) within 24h
3. Check console for: `[P0_PUSH_REG] BOOT_AUTHED ... isAccountSwitch=true`
4. Check console for: `[P0_PUSH_REG] ✓ COMPLETE ... activeCount=1`
5. Verify: User B has active token (user-scoped throttle, no blocking)

### 3. Stale Throttle + Backend Empty → Forced Re-register
1. Login as User C
2. Let registration complete
3. Backend: Manually deactivate User C's tokens (simulate DeviceNotRegistered)
4. Background/foreground the app (triggers checkAndRegisterToken)
5. Check console for: `[P0_PUSH_REG] THROTTLE_BYPASS reason=BACKEND_EMPTY`
6. Check console for: `[P0_PUSH_REG] ✓ COMPLETE ... activeCount=1`

---

## VERIFICATION OUTPUTS

```
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS
```

---

## GIT SHOW --STAT HEAD

```
commit effb24e393c699a50e326c7e264d61c861e1458a (HEAD -> main, origin/main, origin/HEAD)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 06:42:29 2026 -0800

    fix(p0): push token binding SSOT + backend verify

 src/hooks/useNotifications.ts | 296 ++++++++++++++++++++++++++++++++----------
 1 file changed, 199 insertions(+), 97 deletions(-)
```

---

## GIT SHOW --NAME-ONLY HEAD

```
commit effb24e393c699a50e326c7e264d61c861e1458a (HEAD -> main, origin/main, origin/HEAD)
Author: paulyd-oi <pauljdal@gmail.com>
Date:   Tue Feb 3 06:42:29 2026 -0800

    fix(p0): push token binding SSOT + backend verify

src/hooks/useNotifications.ts
```

---

## END OF HANDOFF
