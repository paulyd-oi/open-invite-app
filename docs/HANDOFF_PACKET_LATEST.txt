HANDOFF PACKET - P0: Busy/Work Grey Single Source of Truth + Badge Pill-Only
============================================================================
Date: 2026-01-30
Commit: 6494988
Branch: main
Repo: open-invite-app (frontend)

1) SUMMARY
----------
- Created src/lib/eventPalette.ts as SINGLE SOURCE OF TRUTH for all event color rendering
- GREY_PALETTE constant: { bar: "#6B7280", bg: "#6B728020" } enforced for isBusy OR isWork
- All calendar renderers now delegate to shared module (CompactDayCell, StackedDayCell, DetailsDayCell, EventListItem, FeedCalendar)
- Trophy icon deprecated with "DO NOT USE" comment (badges are pill-only)
- Badge avatar overlays already removed in previous session (friend/[id].tsx, user/[id].tsx)
- Social calendar omit busy already in place with DEV logging
- Busy creation payload verified: sends isBusy: true (calendar.tsx line 1299)

2) FILES CHANGED
----------------
NEW: src/lib/eventPalette.ts        - Single source of truth module
MOD: src/app/calendar.tsx           - Uses shared module for all color logic
MOD: src/components/FeedCalendar.tsx - Uses getEventBarColor() from shared module
MOD: src/ui/icons.tsx               - Trophy export marked DO NOT USE
MOD: docs/STATE_OF_THE_APP.md       - Updated with fixes
MOD: docs/FINDINGS_LOG.md           - Documented root cause

3) KEY DIFFS - Busy Grey Single Source of Truth
-----------------------------------------------

src/lib/eventPalette.ts (NEW):
  const GREY_PALETTE = { bar: "#6B7280", bg: "#6B728020", icon: "#6B7280", text: "#6B7280" }
  getEventPalette(event, themeColor) - returns grey if isBusy OR isWork
  assertGreyPaletteInvariant() - DEV-only logs [BUSY_GREY_INVARIANT_FAIL]

src/app/calendar.tsx:
  Line 44: Import from shared module
  Line 103-108: getEventColor() delegates to getEventBarColor()
  Line 603-607: EventListItem uses getEventPalette() for palette
  Line 609-611: DEV assertion via assertGreyPaletteInvariant()

src/components/FeedCalendar.tsx:
  Line 10: Import getEventBarColor from shared module
  Line 24-34: getEventColor() delegates to getEventBarColor()

4) PROOF - Busy Create API Payload
----------------------------------
calendar.tsx line 1294-1300:
  api.post("/api/events", { ..., isBusy: true })  // CONFIRMED

5) PROOF - getEventPalette Call Sites (3+ locations)
----------------------------------------------------
1. calendar.tsx line 107: getEventColor() -> getEventBarColor()
2. calendar.tsx line 603: EventListItem -> getEventPalette()
3. FeedCalendar.tsx line 34: getEventColor() -> getEventBarColor()

6) PROOF - Trophy Not Used
--------------------------
rg -n "Trophy" src/app src/components src/ui
-> Only comments and deprecation notice, no actual <Trophy> usage

7) VERIFICATION OUTPUT
----------------------
bun run typecheck: No errors
bash scripts/ai/verify_frontend.sh: PASS

8) ROOT CAUSE (Documented in docs/FINDINGS_LOG.md)
-------------------------------------------------
- Multiple divergent render paths for event colors
- calendar.tsx getEventColor() checked isBusy but NOT isWork
- FeedCalendar.tsx had its own getEventColor() with different logic
- Fix: Single source of truth module eliminates divergence

9) COMMANDS RUN
---------------
bun run typecheck
bash scripts/ai/verify_frontend.sh
rg -n "Trophy" src/app src/components src/ui
git add -A && git commit -m "fix(P0): busy/work grey single source of truth + badge pill-only"
git push origin main

10) MANUAL TEST CHECKLIST
-------------------------
[ ] Create busy block -> verify grey bar + grey bg in month view
[ ] Tap day with busy -> verify grey in day list
[ ] Check work calendar events -> verify grey rendering
[ ] Check Social tab -> verify NO busy events appear
[ ] Check friend profile avatar -> NO badge overlay (pill only)
[ ] Check user/[id] profile -> NO badge overlay (pill only)
[ ] Check Profile -> Badges section shows Award icon (not Trophy)

END HANDOFF
