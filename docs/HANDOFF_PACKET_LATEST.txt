HANDOFF PACKET â€” CREATEELEMENT TEXT-CHILD DETECTOR (DEV-ONLY)
==============================================================
Date: 2025-01-30
Branch: main
Commit: (see git log)
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Added a DEV-only React.createElement patch that detects when string or number
children are rendered inside non-Text components BEFORE the crash happens.
This gives us the exact component name and callsite stack trace.

FILES CHANGED
-------------
src/app/_layout.tsx (added ~80 lines after existing console.error interceptor)

KEY IMPLEMENTATION
------------------
1. Patches React.createElement once (uses global flag to prevent double-patch)
2. For every element creation:
   - Derives typeName from type (string, function.displayName, function.name)
   - Flattens all children (including props.children)
   - If any child is string/number AND type is NOT Text-like, logs detection
3. Text-like types allowed: Text, RCTText, AnimatedText, TextInput, or any
   component with "Text" in the name
4. Limits to first 5 detections to prevent console spam
5. Wrapped in if (__DEV__) so prod is untouched

WHAT THE DETECTOR PRINTS
------------------------
When a text child is rendered in a non-Text component:

=== INVALID TEXT CHILD DETECTED ===
Component: View
Offending child: "some string" (typeof: string)
Props keys: className, style
Stack trace:
    at patchedCreateElement (_layout.tsx:XX)
    at SomeComponent (SomeFile.tsx:YY)
    at renderWithHooks (...)
    ...
=== Detection 1/5 ===

HOW TO USE IT
-------------
1. Clear cache and start dev server:
   npx expo start -c

2. Navigate to screen that causes crash

3. Check Metro console for:
   "[DEV] React.createElement text-child detector installed"
   
4. When crash occurs, look for:
   "=== INVALID TEXT CHILD DETECTED ==="
   The "Component:" line shows the parent receiving the bad child
   The "Stack trace:" shows the exact file/line of the render

5. Fix the file by wrapping the string/number in <Text>

VERIFICATION OUTPUT
-------------------
$ npm run typecheck
> tsc -p tsconfig.frontend.json --noEmit
(no errors)

$ bash scripts/ai/verify_frontend.sh
== INVARIANT CHECK PASSED ==
== TYPECHECK ==
PASS: verify_frontend

EXISTING DETECTORS (KEPT)
-------------------------
1. console.error interceptor (lines 51-62) - catches error message
2. ErrorBoundary componentDidCatch (src/components/ErrorBoundary.tsx)
3. NEW: React.createElement patch (lines 66-159) - catches BEFORE crash

DIFF SUMMARY
------------
src/app/_layout.tsx:
  - Added ~80 lines after the existing console.error interceptor
  - No existing code modified
  - DEV-only (if (__DEV__) wrapper)
  - Uses global flag to prevent double-patching on hot reload

NOTES
-----
- This detector fires BEFORE the actual crash, giving actionable callsite info
- The existing console.error interceptor still works as a secondary catch
- Detector is completely inert in production builds
- If crash still happens without detector logs, the issue may be in a library
  or in code that doesn't go through React.createElement (rare)
