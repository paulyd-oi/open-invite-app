========================================
HANDOFF PACKET - Push Notification Permission Request + Token Validation
========================================
Date: 2025-01-29
Branch: main
Author: GitHub Copilot (Claude Opus 4.5)

========================================
SUMMARY
========================================
Fixed push notification bootstrap to:
1. REQUEST permission when undetermined (not just read status)
2. VALIDATE tokens before sending (block placeholder/test tokens)
3. Handle all permission states properly (undetermined/granted/denied)
4. Gate all network calls on bootStatus === 'authed'

ROOT CAUSE: Hook was only reading permission status, never requesting
it when undetermined. Also no validation to block placeholder tokens.

========================================
FILES CHANGED
========================================
src/hooks/useNotifications.ts
  - Added isValidPushToken() helper to reject placeholder tokens
  - Updated checkAndRegisterToken() to REQUEST permission when undetermined
  - Added token validation before sending to backend
  - All logs use [PUSH_BOOTSTRAP] prefix consistently

========================================
KEY DIFFS
========================================
1. NEW: Token validation (blocks ExponentPushToken[test123] etc):
   const isValidPushToken = (token: string): boolean => {
     if (!token.startsWith('ExponentPushToken[')) return false;
     if (token.toLowerCase().includes('test')) return false;
     if (token.length < 30) return false;
     return true;
   };

2. NEW: Request permission when undetermined:
   if (status === 'undetermined') {
     console.log("[PUSH_BOOTSTRAP] Requesting permission from OS...");
     const { status: newStatus } = await Notifications.requestPermissionsAsync();
     status = newStatus;
   }

3. Token validation before backend call:
   if (token && isValidPushToken(token)) {
     // Send to backend
   } else if (token) {
     // Token failed validation, log and skip register-token
   }

========================================
VERIFICATION
========================================
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS
- AUTH_CONTRACT.md exists
- No !!session gating found
- No uppercase Cookie headers
- Guidance keys user-scoped
- Invariant check PASSED

========================================
PROOF STEPS (when real device build exists)
========================================
1. Build TestFlight: shipios

2. Install on real device, open app

3. When prompted, GRANT notification permission

4. Check backend (within 1 min):
   curl -X GET https://open-invite-backend.onrender.com/api/notifications/device-tokens \
     -H "Cookie: <auth_cookie>"
   Expected: { "activeCount": 1, ... }

5. Test push delivery:
   curl -X POST https://open-invite-backend.onrender.com/api/notifications/test-push \
     -H "Content-Type: application/json" \
     -H "Cookie: <auth_cookie>" \
     -d '{"userId": "<USER_ID>"}'
   Expected: { "success": true }

6. Device should receive push notification

========================================
RUNTIME NOTES (DEV console logs)
========================================
On app boot with authed user:
  [PUSH_BOOTSTRAP] Skipping - bootStatus: booting hasUser: false
  ... (auth completes)
  [PUSH_BOOTSTRAP] Boot complete, initiating push registration
  [PUSH_BOOTSTRAP] Initial permission status: undetermined
  [PUSH_BOOTSTRAP] Requesting permission from OS...
  [PUSH_BOOTSTRAP] Permission after request: granted
  [PUSH_BOOTSTRAP] Getting push token...
  [PUSH_BOOTSTRAP] Got valid token: ExponentPushToken[abc123...
  [PUSH_BOOTSTRAP] Token registered with /api/notifications/register-token
  [PUSH_BOOTSTRAP] Permission status updated to granted
  [PUSH_BOOTSTRAP] âœ“ Push registration complete

On simulator (no real token):
  [PUSH_BOOTSTRAP] No token available (simulator/unsupported)

On placeholder token (should NOT happen now):
  [PUSH_BOOTSTRAP] Rejected placeholder token: ExponentPushToken[test123]
  [PUSH_BOOTSTRAP] Token failed validation, not sending to backend

========================================
INVARIANTS PRESERVED
========================================
- No new dependencies added
- expo-device already used in registerForPushNotificationsAsync
- bootStatus gating pattern maintained
- Auth contract preserved
- Minimal diff (single file)

========================================
END OF HANDOFF
========================================
