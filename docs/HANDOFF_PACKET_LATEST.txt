HANDOFF PACKET — PUSH DIAGNOSTICS UI + PRODUCTION REGISTRATION
================================================================
Date: 2025-01-31
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Added user-visible Push Diagnostics panel in Settings that works in TestFlight.
Users can now:
1. Tap "Register Now" to run full push registration with on-screen results
2. Tap "Clear My Tokens" to delete all tokens and verify empty state
3. See detailed diagnostic info: device, permission, projectId, token prefix/length,
   validation result, POST status, GET /api/push/me response with all tokens

This is NOT DEV-only - it runs in production TestFlight builds for allowlisted users.

FILES CHANGED
-------------
1. src/hooks/useNotifications.ts
   - Enhanced runPushDiagnostics() to return comprehensive diagnostic info:
     * isPhysicalDevice, permission, projectId
     * tokenPrefix, tokenLength, isValidToken
     * postStatus, postBody, getStatus, getBody
     * backendActiveCount, backendTokens array
   - Added clearMyPushTokens() function: POST /api/push/clear-mine then GET /api/push/me

2. src/app/settings.tsx
   - Added Push Diagnostics Modal with:
     * "Register Now" button - runs full registration flow
     * "Clear Tokens" button - clears all user tokens from backend
     * Results panel showing all diagnostic values
     * Backend tokens list with ACTIVE/INACTIVE status
     * POST response preview
   - Updated state management for modal and results

KEY IMPLEMENTATION
------------------
useNotifications.ts runPushDiagnostics() returns:
{
  ok: boolean;
  reason: string;
  isPhysicalDevice: boolean;
  permission?: string;
  projectId?: string;
  tokenPrefix?: string;
  tokenLength?: number;
  isValidToken?: boolean;
  postStatus?: number | string;
  postBody?: unknown;
  getStatus?: number | string;
  getBody?: unknown;
  backendActiveCount?: number;
  backendTokens?: Array<{ tokenPrefix?: string; isActive?: boolean }>;
}

clearMyPushTokens() returns:
{
  ok: boolean;
  error?: string;
  tokens?: Array<{ tokenPrefix?: string; isActive?: boolean }>;
}

RUNTIME STATUS
--------------
✓ npm run typecheck: PASS
✓ bash scripts/ai/verify_frontend.sh: PASS

TESTFLIGHT VERIFICATION STEPS
-----------------------------
1. Install TestFlight build on physical iPhone
2. Sign in with allowlisted email (pauljdal@gmail.com, paulydal@ymail.com, etc.)
3. Go to Settings → scroll to Notifications section → tap "Push Diagnostics"
4. Modal opens showing instructions

5. Tap "Clear Tokens" first (to test fresh state)
   - Should show "Tokens cleared" toast
   - Results panel shows backendTokens: [] or count 0

6. Tap "Register Now"
   - Should show "Running..." then results
   - Expected SUCCESS results:
     * Physical Device: Yes ✓
     * Permission: granted
     * Project ID: <UUID> (not NOT_FOUND)
     * Token Prefix: ExponentPushToken[REAL... (NOT containing "test")
     * Token Length: 44+ (not < 30)
     * Valid Token: Yes ✓
     * POST Status: 200
     * GET Status: 200
     * Active Tokens: 1+
   - Backend Tokens list shows your real token with ACTIVE badge

7. Verify backend directly:
   curl -b /tmp/oi.txt https://open-invite-api.onrender.com/api/push/me
   Expected: tokenPrefix NOT "test123", isActive = true

FAILURE SCENARIOS
-----------------
| Screen Shows                | Meaning                          | Fix                    |
|-----------------------------|----------------------------------|------------------------|
| Physical Device: No         | Running on simulator             | Use real iPhone        |
| Permission: denied          | User denied notifications        | Grant in iOS Settings  |
| Project ID: NOT_FOUND       | Missing EAS config               | Check app.json/eas     |
| Token Prefix: ...test...    | Placeholder token                | Real device required   |
| Valid Token: No             | Token failed validation          | Check logs for reason  |
| POST Status: 401            | Auth cookie missing              | Re-sign in             |
| POST Status: 404/500        | Backend route issue              | Check backend logs     |
| Active Tokens: 0            | Backend didn't persist           | Check POST response    |

ENDPOINTS USED
--------------
- POST /api/push/register { token, platform: "expo" }
- POST /api/push/clear-mine {}
- GET /api/push/me

WHAT'S NOT CHANGED
------------------
- Navigation architecture
- Icon system
- Auth flow
- Other settings items
- No new dependencies

PREVIOUS WORK (still in place)
------------------------------
- Shared validator: src/lib/push/validatePushToken.ts
- DEV-only [PUSH_PROOF] logs on cold start
- DEV-only [NUDGE_PROOF] logs in NotificationNudgeModal
- 24h throttle for foreground re-registration
