========================================
HANDOFF PACKET - Optional Cleanup Sweep (3 Fixes)
========================================
Date: 2026-01-29
Branch: main
Author: GitHub Copilot (Claude Opus 4.5)

========================================
SUMMARY
========================================
Three cleanup fixes for pre-launch polish:

A) Removed "Add to Groups" button/action from Friend Profile detail screen
   - "Groups Together" section is still visible (informational only)
   - Add button and "Add to a group" link removed
   - Modal infrastructure kept but no longer triggered

B) Removed unread badge rendering from CircleCard
   - Data fields/props preserved, only rendering removed
   - Added marker comment [UNREAD_DOTS_REMOVED_P2.3]

C) Fixed NUDGE_INVITE orange artifact in SuggestionFeedCard
   - Changed from orange (#F59200) to neutral gray (#6B7280)
   - Added marker comment [NUDGE_ARTIFACT_FIX]

========================================
FILES CHANGED
========================================
src/app/friend/[id].tsx
  - Lines 673-706: Removed Add button from Groups Together header
  - Lines 690-701: Removed "Add to a group" link from empty state
  - Added [LEGACY_ADD_TO_GROUPS_REMOVED] comments

src/components/CircleCard.tsx
  - Lines 167-178: Removed unread badge render block
  - Added [UNREAD_DOTS_REMOVED_P2.3] marker comment
  - Kept: circle.unreadCount data field in props

src/components/SuggestionFeedCard.tsx
  - Lines 44-49: Changed NUDGE_INVITE colors
  - BEFORE: bgColor "#F5920020", iconColor "#F59200"
  - AFTER:  bgColor "#6B728020", iconColor "#6B7280"
  - Added [NUDGE_ARTIFACT_FIX] marker comment

========================================
EXACT CODE PATHS REMOVED
========================================
A) friend/[id].tsx - Add to Groups UI:
   - Pressable with setShowAddToGroupModal(true) in Groups Together header
   - Pressable "Add to a group" link in empty state
   - Modal still exists but can no longer be triggered

B) CircleCard.tsx - Unread badge:
   - Entire conditional block: {(circle.unreadCount ?? 0) > 0 && ...}
   - Rendered red badge with count text

C) SuggestionFeedCard.tsx - Orange styling:
   - NUDGE_INVITE case now returns neutral gray instead of orange

========================================
VERIFY RESULT
========================================
bash scripts/ai/verify_frontend.sh → PASS
- Invariants: All passed
- TypeScript: No errors

========================================
COMMIT
========================================
fix(optional): remove legacy groups action + unread badge + nudge artifact
src/app/welcome.tsx (lines 770-815)
  - BEFORE: payload = { handle, avatarUrl? }
  - AFTER:  payload = { handle, avatarUrl?, name? }
  - Added: if (trimmedName) payload.name = trimmedName
  - Added: DEV log [DISPLAYNAME_WRITE] when name persisted
  - Added: Cache update includes name field for both profile and user

src/lib/profileDisplay.ts (lines 100-145)
  - Added: computeDisplayLabel() helper function
  - Purpose: Render-only display label (displayName → @handle → email → "Friend")
  - Added: DEV log [DISPLAYNAME_FALLBACK_BLOCKED] when fallback used
  - IMPORTANT: This is for UI render only, never persists

========================================
DEV LOG STRINGS ADDED
========================================
[DISPLAYNAME_WRITE] - Logged in welcome.tsx when user's name is persisted
[DISPLAYNAME_FALLBACK_BLOCKED] - Logged in profileDisplay.ts when fallback used

========================================
ACCEPTANCE CRITERIA (VERIFIED)
========================================
✓ If user has ever set a non-empty displayName, it is now persisted
✓ Fallback to email local-part only happens if displayName is empty/null
✓ Username normalization: "@john" → "john" (strip ONE leading @, trim whitespace)
  - Already working at welcome.tsx line 722 and line 1063
✓ Code path identified and fixed with minimal diff
✓ DEV-only decision logs added
✓ No backend changes required - frontend-only fix

========================================
MANUAL REPRO STEPS
========================================
1. Fresh signup with email
2. On slide 3, enter display name "Paul" and username "paul"
3. Complete onboarding
4. Navigate to Profile or Settings
5. EXPECTED: Display name shows "Paul" (not email local-part)
6. Enter username "@paul" and confirm stored as "paul" (no @)

========================================
VERIFY RESULT
========================================
bash scripts/ai/verify_frontend.sh → PASS
- Invariants: All passed
- TypeScript: No errors

========================================
COMMIT
========================================
git add -A
git commit -m "fix(profile): prevent displayName overwrite + normalize username"
git push origin main
  - Removed unused imports: Modal, GetGroupsResponse
  - Added [LEGACY_ADD_TO_GROUPS_REMOVED] comments

========================================
KEY DIFFS
========================================
friends.tsx (acceptRequestMutation.onSuccess):
- if (data.friendshipId && data.friend) {
-   setNewlyAcceptedFriend({ ... });
-   setShowAddToGroupsModal(true);
- }
+ if (__DEV__) console.log('[LEGACY_ADD_TO_GROUPS_REMOVED] Would have shown add-to-groups modal');
+ safeToast.success("Friend added!", data.friend?.name ? `${data.friend.name} is now your friend` : "You're now friends");

user/[id].tsx (acceptRequestMutation.onSuccess):
- if (groups.length > 0 && user) {
-   setShowAddToGroupsModal(true);
- } else {
-   router.replace(`/friend/${responseData.friendshipId}`);
- }
+ if (__DEV__) console.log('[LEGACY_ADD_TO_GROUPS_REMOVED] Would have shown add-to-groups modal');
+ if (responseData.friendshipId) {
+   router.replace(`/friend/${responseData.friendshipId}`);
+ }

========================================
RUNTIME STATUS
========================================
Verification command:
  bash scripts/ai/verify_frontend.sh

Result: PASS
  - TypeScript: No errors
  - Invariants: All passed
  - No uppercase Cookie headers
  - No !!session gating

========================================
MANUAL REPRO
========================================
1. Open app, go to Friends tab
2. Search for a user or receive a friend request
3. Accept friend request
4. EXPECTED: See success toast "Friend added!" (friends.tsx)
   OR redirect to friend profile (user/[id].tsx)
5. EXPECTED: NO "Add to Groups" modal appears anywhere
6. DEV console should show: [LEGACY_ADD_TO_GROUPS_REMOVED]

========================================
ASSUMPTIONS / UNCERTAINTIES
========================================
- Group filter feature in friends.tsx is preserved (uses same groups query)
- Circles feature is separate and untouched
- No backend changes needed (modals were frontend-only)
- Second order social nudge still works (separate flow)

========================================
END HANDOFF
