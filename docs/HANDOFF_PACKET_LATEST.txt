========================================
HANDOFF PACKET - Frontend Patch #4 (Masked Busy Blocks)
Date: 2026-01-29
========================================

SUMMARY
-------
Implemented frontend support for masked busy blocks from backend:

Backend Patch #3 sends masked busy blocks for circle events that
friends cannot see with the contract:
{ id: "busy_<cuid>", startAt, endAt, isBusy: true }

This patch handles those items in the friend calendar view:
1. Type guard to detect masked busy items (isBusy=true, no title)
2. Field normalization (startAt→startTime, endAt→endTime)
3. Grey rendering in friend calendar (not theme color)
4. Tap protection (no navigation for busy-only days)
5. Legend updated to show "Busy" indicator

KEY IMPLEMENTATION DETAILS
--------------------------
- isMaskedBusy(item): Checks isBusy===true && !item.title
- normalizeBusyItem(): Maps startAt/endAt to startTime/endTime, fills required Event fields
- normalizeEventsWithBusy(): Processes entire events array
- busyColor: isDark ? "#6B6B6B" : "#9CA3AF" (consistent with main calendar)
- Busy items filtered before groupEventsIntoSeries() to prevent crash
- Events take priority over busy (if both exist, theme color used)

FILES CHANGED
-------------
src/app/friend/[id].tsx:
  - Added isMaskedBusy() type guard
  - Added normalizeBusyItem() normalizer
  - Added normalizeEventsWithBusy() processor
  - FriendCalendar: Separate eventsByDate/busyByDate maps
  - FriendCalendar: busyColor constant for grey rendering
  - FriendCalendar: Updated renderDays() for grey busy dots
  - FriendCalendar: Updated legend with "Busy" entry
  - FriendCalendar: handleDayPress prevents navigation for busy-only days
  - events normalized with useMemo + normalizeEventsWithBusy()
  - eventSeries filters out busy before grouping

docs/STATE_OF_THE_APP.md - Updated with masked busy handling

ALSO IN THIS SESSION (Patch #1)
-------------------------------
src/app/admin.tsx - handleBadgeToggle with haptics
src/app/calendar.tsx - Busy pill and modal added  
src/app/circle/[id].tsx - DEV logging for remove button

VERIFICATION RESULTS
--------------------
npm run typecheck: PASS
bash scripts/ai/verify_frontend.sh: PASS

TESTING NOTES
-------------
To test masked busy blocks:
1. Create a circle with friend A
2. Create a circle event as friend B (not in that circle with A)
3. View friend B's calendar as friend A
4. Should see grey "Busy" block, tapping does nothing

========================================
END HANDOFF
========================================
