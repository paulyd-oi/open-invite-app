HANDOFF PACKET â€” APPLE SIGN-IN PROOF SWEEP
===========================================
Date: 2026-01-30
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Added hardened logging and error classification to Apple Sign-In flow.
- Error bucket classification: user_cancel, native_entitlement_or_provisioning, network_error, backend_rejection, other_native_error
- Production-safe logging (always logs stage, sensitive data only in __DEV__)
- DEV-only diagnostic helper function for TestFlight debugging
- Config proof sweep: all config correct (usesAppleSignIn: true, bundleIdentifier, expo-apple-authentication package)

CONFIG PROOF SWEEP RESULTS
--------------------------
OK app.json:
   - "usesAppleSignIn": true (line 16)
   - "bundleIdentifier": "com.vibecode.openinvite.0qi5wk" (line 14)
   - "scheme": "open-invite" (line 5)
   - No expo-apple-authentication in plugins (correct - auto-configured via usesAppleSignIn)

OK package.json:
   - "expo-apple-authentication": "~7.2.4" (line 50)

OK eas.json:
   - Production build config present
   - No Apple-specific config needed (handled by usesAppleSignIn)

FILES CHANGED
-------------
1. src/lib/appleSignIn.ts
   - Added AppleAuthErrorBucket type for error classification
   - Added classifyAppleAuthError() function to bucket errors
   - Added runAppleSignInDiagnostics() DEV helper function
   - Exported AppleAuthentication module reference

2. src/app/welcome.tsx
   - Imported classifyAppleAuthError, runAppleSignInDiagnostics, AppleAuthErrorBucket
   - Added getBucketExplanation() helper for diagnostic logs
   - Updated traceLog to always log stage (production-safe)
   - Updated traceError to include bucket classification
   - Renamed stages: apple_auth_request_start, native_signInAsync_start, native_signInAsync_success, apple_auth_backend_start, apple_auth_backend_response
   - Enhanced credential logging: hasUser, hasGivenName, hasFamilyName, authorizationCodeLength
   - Added DEV-only "[DEV] Run Apple Sign-In Diagnostics" button on Slide 2

KEY DIFFS
---------
appleSignIn.ts:
+export type AppleAuthErrorBucket = "user_cancel" | "native_entitlement_or_provisioning" | "network_error" | "backend_rejection" | "other_native_error";
+export function classifyAppleAuthError(error: any): AppleAuthErrorBucket
+export async function runAppleSignInDiagnostics(): Promise<void>

welcome.tsx:
+import { ..., classifyAppleAuthError, runAppleSignInDiagnostics } from "@/lib/appleSignIn";
+import type { AppleAuthErrorBucket } from "@/lib/appleSignIn";
+function getBucketExplanation(bucket: AppleAuthErrorBucket): string
+const errorBucket = classifyAppleAuthError(error);
+traceError("final_fail", { ...error, bucket: errorBucket, bucketExplanation: ... });

COMMANDS RUN
------------
npm run typecheck -> PASS (no errors)
bash scripts/ai/verify_frontend.sh -> PASS

TESTFLIGHT VERIFICATION CHECKLIST
---------------------------------
1. Install TestFlight build on real iOS device (not simulator)

2. Navigate to welcome/onboarding screen (Slide 2)

3. (DEV ONLY) Tap "[DEV] Run Apple Sign-In Diagnostics" link
   - Check Xcode console for "[APPLE_AUTH_DIAG]" logs
   - Verify: isAvailableAsync() returns true
   - If false -> entitlement/provisioning issue

4. Tap "Continue with Apple" button

5. EXPECTED LOGS (check Xcode console):
   [APPLE_AUTH_TRACE] apple_<id> | apple_auth_request_start
   [APPLE_AUTH_TRACE] apple_<id> | availability_check
   [APPLE_AUTH_TRACE] apple_<id> | native_signInAsync_start
   
   SUCCESS PATH:
   [APPLE_AUTH_TRACE] apple_<id> | native_signInAsync_success
   [APPLE_AUTH_TRACE] apple_<id> | apple_auth_backend_start
   [APPLE_AUTH_TRACE] apple_<id> | apple_auth_backend_response
   [APPLE_AUTH_TRACE] apple_<id> | token_extraction
   [APPLE_AUTH_TRACE] apple_<id> | final_success

   FAILURE PATHS:
   A) Native entitlement/provisioning:
      [APPLE_AUTH_TRACE] apple_<id> | final_fail | bucket=native_entitlement_or_provisioning
      -> CAUSE: Sign in with Apple capability not in provisioning profile
      -> FIX: Check Apple Developer Console, regenerate provisioning profile

   B) User cancel:
      [APPLE_AUTH_TRACE] apple_<id> | user_cancelled
      -> CAUSE: User tapped Cancel
      -> This is expected behavior, no fix needed

   C) Backend rejection:
      [APPLE_AUTH_TRACE] apple_<id> | final_fail | bucket=backend_rejection
      -> CAUSE: Backend rejected Apple identity token
      -> FIX: Check backend logs, verify /api/auth/apple endpoint

   D) Other native error:
      [APPLE_AUTH_TRACE] apple_<id> | final_fail | bucket=other_native_error
      -> CAUSE: Unknown - check error code/message in logs

HOW TO INTERPRET FAILURE MODES
------------------------------
bucket=native_entitlement_or_provisioning
  -> Smoking gun: app binary missing Sign in with Apple entitlement
  -> Check: Apple Developer Console -> App ID -> Capabilities -> Sign in with Apple
  -> Check: Provisioning profile was regenerated AFTER adding capability
  -> Check: EAS build used correct provisioning profile

bucket=user_cancel
  -> User dismissed Apple sheet - normal behavior

bucket=network_error
  -> Device connectivity issue - user should retry

bucket=backend_rejection
  -> Token valid but backend rejected - check backend logs
  -> Verify /api/auth/apple endpoint is deployed and working

bucket=other_native_error
  -> Rare - check error.code and error.message for details

RISKS / ROLLBACKS
-----------------
- Minimal risk: logging-only changes, no behavioral changes
- Rollback: revert src/lib/appleSignIn.ts and src/app/welcome.tsx
- No new dependencies added
- No navigation architecture changes

NEXT STEPS
----------
1. Build new TestFlight with these changes
2. Test Apple Sign-In on real device
3. Capture logs to determine failure bucket
4. If bucket=native_entitlement_or_provisioning -> fix provisioning in Apple Developer Console
5. If bucket=backend_rejection -> investigate backend /api/auth/apple endpoint
