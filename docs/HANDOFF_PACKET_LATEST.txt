HANDOFF PACKET: P0 PRIVACY SWEEP - BUSY MUST MASK TITLE EVERYWHERE
===================================================================
Date: 2025-01-XX
Commit: d7c2545 (fix(privacy): P0 centralized busy event masking)
Branch: main
Status: COMPLETE âœ…

ROOT CAUSE
----------
1. circle/[id].tsx line ~146: MiniCalendar only checked isPrivate, not isBusy/isWork
2. friend/[id].tsx EventCard: NO masking at all - showed real titles for all events

FIX SUMMARY
-----------
Created centralized masking helper in /src/lib/eventVisibility.ts:
- shouldMaskEvent(event, isOwner) â†’ boolean
- getEventDisplayFields(event, isOwner) â†’ {displayTitle, displayEmoji, displayLocation, displayDescription, isMasked}

Masking Logic:
  isMasked = (isBusy || isWork) && !isOwner
  masked â†’ title="Busy", emoji="ðŸ”’", location=undefined, description=undefined

FILES CHANGED (5 files, +165/-42)
---------------------------------
1. src/lib/eventVisibility.ts - NEW: Centralized masking helpers (88 lines)
2. src/app/calendar.tsx - EventListItem uses getEventDisplayFields()
3. src/app/circle/[id].tsx - MiniCalendar now checks isBusy/isWork (was only isPrivate)
4. src/app/friend/[id].tsx - EventCard has masking + navigation blocked for masked
5. src/components/FeedCalendar.tsx - EventListItem uses centralized helper

BLAST-RADIUS PROOF
------------------
grep -rn "event\.title" --include="*.tsx" src/ | wc -l â†’ 33 usages audited

All calendar render paths verified:
- calendar.tsx EventListItem âœ…
- circle/[id].tsx MiniCalendar âœ…  
- friend/[id].tsx EventCard âœ…
- FeedCalendar.tsx EventListItem âœ…

VERIFICATION PROOF
------------------
npm run typecheck â†’ PASS (no errors)
bash scripts/ai/verify_frontend.sh â†’ PASS: verify_frontend

DEV LOGGING
-----------
Tag: [P0_PRIVACY_BUSY]
Sample: [P0_PRIVACY_BUSY] Masking event "Real Title" (isBusy=true, isOwner=false)

REPRO STEPS FOR VERIFICATION
----------------------------
1. Create event with isBusy=true
2. View from another user's friend calendar or circle calendar
3. Should see "Busy" with ðŸ”’, NOT real title
4. Tap should NOT navigate to event details

PREVIOUS FIXES (PRESERVED)
--------------------------
- Subscription section always renders card (Free/Pro), never blank
- Notification toggle reflects OS permission state (granted/denied/undetermined)
- useFocusEffect refreshes permission status when returning from Settings
- Toggle cannot be ON when OS permission not granted
- Change Color available on ALL events
- Private/busy event detail shows "This time is blocked" message

KEY DIFFS
---------
SubscriptionContext.tsx:
+  const loadingTimeoutRef = useRef<NodeJS.Timeout | null>(null);
+  useEffect(() => {
+    loadingTimeoutRef.current = setTimeout(() => {
+      if (isLoading) setIsLoading(false);
+    }, 5000);
+    return () => { clearTimeout(...) };
+  }, []);

activity.tsx:
-  const ACTIVITY_PERMISSION_ASKED_KEY = "@openinvite_activity_permission_asked";
+  const getActivityPermissionKey = (userId: string) => 
+    `@openinvite_activity_permission_asked_${userId}`;

notification-settings.tsx:
+  {osPermissionStatus === "denied" && (
+    <Pressable onPress={() => Linking.openSettings()}>
+      <Settings size={16} /> Enable in Settings
+    </Pressable>
+  )}

VERIFICATION
------------
âœ… yarn typecheck PASS
âœ… bash scripts/ai/verify_frontend.sh PASS

QA TEST PLAN
------------
[ ] Settings: Subscription section renders immediately (no blank), updates to Pro if Pro
[ ] Settings: Wait 5+ seconds with network issues â†’ still shows Free card (not stuck loading)
[ ] Activity: First open triggers permission request only if undetermined, only once per user
[ ] Activity: Switch accounts â†’ permission prompt can appear for new user
[ ] Notification settings: Toggle reflects OS permission state
[ ] Notification settings: Toggle updates after changing permission in iOS Settings
[ ] Notification settings: Toggle cannot be ON when OS permission denied/undetermined
[ ] Notification settings: "Enable in Settings" button visible when permission denied
[ ] Notification settings: Clicking "Enable in Settings" opens device Settings

FILES MODIFIED
--------------
- src/lib/SubscriptionContext.tsx (loading timeout fallback)
- src/app/activity.tsx (user-scoped permission tracking)
- src/app/notification-settings.tsx (Enable in Settings CTA + Settings icon import)
--------------
- src/app/settings.tsx (subscription block loading state)
- src/components/FeedCalendar.tsx (EventListItem busy/private handling)
- src/app/activity.tsx (first-open permission request)
- src/app/notification-settings.tsx (OS permission state sync)
- src/app/suggestions.tsx (SuggestionCard @username + bio)
- src/app/calendar.tsx (Change Color ungated - available everywhere)
- src/app/event/[id].tsx (private/busy UX message)
- src/app/event/edit/[id].tsx (private/busy UX message)
- src/app/calendar.tsx (Change Color ungated from isOwner)
