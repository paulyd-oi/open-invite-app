HANDOFF PACKET — FRIENDS FLATLIST VIRTUALIZATION TUNING
====================================================================
Date: 2025-02-01
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Improved Friends list smoothness with 50+ friends by converting from 
ScrollView + .map() to FlatList with proper virtualization tuning.

CHANGES — BEFORE/AFTER
----------------------

### Friends List (Main Change)

BEFORE (src/app/friends.tsx lines 1618-1639):
```tsx
viewMode === "list" ? (
  filteredFriends.map((friendship, index) => (
    <FriendListItem key={friendship.id} ... />
  ))
) : (
  filteredFriends.map((friendship, index) => (
    <FriendCard key={friendship.id} ... />
  ))
)
```

AFTER:
```tsx
<FlatList
  data={filteredFriends}
  keyExtractor={friendKeyExtractor}
  renderItem={viewMode === "list" ? renderFriendListItem : renderFriendCard}
  initialNumToRender={10}
  maxToRenderPerBatch={10}
  windowSize={9}
  updateCellsBatchingPeriod={50}
  removeClippedSubviews={Platform.OS === 'android'}
  nestedScrollEnabled
  scrollEnabled={false}
  extraData={pinnedFriendshipIds}
/>
```

### FlatList Props Added

| Prop | Value | Why |
|------|-------|-----|
| initialNumToRender | 10 | Render ~1 viewport initially |
| maxToRenderPerBatch | 10 | Limit batch size, prevent frame drops |
| windowSize | 9 | ~4.5 viewports above/below |
| updateCellsBatchingPeriod | 50 | 50ms batching reduces re-renders |
| removeClippedSubviews | Android only | iOS can have clipping bugs |
| scrollEnabled | false | Parent ScrollView handles scroll |
| nestedScrollEnabled | true | Required for nested FlatList |
| extraData | pinnedFriendshipIds | Re-render when pins change |

### getItemLayout
NOT ADDED - Row heights are variable:
- FriendCard: optional bio (numberOfLines=2), optional badge, MiniCalendar
- FriendListItem: collapsible calendar section, optional badge
getItemLayout requires fixed heights; cannot use here.

### Memoization Added
- friendKeyExtractor: useCallback((item) => item.id, [])
- handlePinFriend: useCallback wrapper for mutation
- renderFriendListItem: useCallback with [bootStatus, handlePinFriend, pinnedFriendshipIds]
- renderFriendCard: useCallback with [bootStatus, handlePinFriend, pinnedFriendshipIds]

### Contacts Modal (Secondary)
Same virtualization props applied:
- initialNumToRender={12}
- maxToRenderPerBatch={10}
- windowSize={9}
- updateCellsBatchingPeriod={50}
- removeClippedSubviews={Platform.OS === 'android'}

DEV INSTRUMENTATION
-------------------
```tsx
// On mount:
console.time("[PERF] Friends screen first render");

// After data loads:
console.timeEnd("[PERF] Friends screen first render");
console.log(`[PERF] Friends list count: ${filteredFriends.length}`);
```

FILES CHANGED
-------------
1. src/app/friends.tsx (MODIFIED)
   - Added DEV timing instrumentation
   - Added memoized keyExtractor and renderItem callbacks
   - Converted friends list from .map() to FlatList
   - Added virtualization props to contacts modal FlatList

2. docs/FINDINGS_LOG.md (MODIFIED)
   - Added Friends FlatList Virtualization entry

VERIFICATION
------------
$ npm run typecheck
(no errors)

$ bash scripts/ai/verify_frontend.sh
PASS: verify_frontend

REGRESSION RISK
---------------
LOW - FlatList inside ScrollView with scrollEnabled={false} preserves existing 
scroll behavior. Virtualization only affects mount + off-screen items.

MANUAL TESTING RECOMMENDED
--------------------------
1. Add 30+ friends
2. Navigate to Friends tab
3. Scroll through list - should feel smooth
4. Toggle between List/Detailed view modes
5. Expand/collapse friends section
6. Verify no visual clipping issues
7. Pin/unpin friends - should still work

COMMIT
------
perf(friends): tune FlatList virtualization for smoother scroll

PREVIOUS SESSION
----------------
Frontend full audit (launch readiness) - audit-only, no fixes needed
