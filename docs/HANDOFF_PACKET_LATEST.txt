HANDOFF PACKET: P0 Subscription Fallback + Notification Permission Truth
=========================================================================
Date: 2026-02-03
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Hardened P0 invariants for subscription loading and notification permission state.
Added timeout fallback to prevent stuck loading, user-scoped permission tracking,
and explicit "Enable in Settings" CTA for denied permission state.

P0 FIXES (THIS SESSION)
-----------------------

1. Subscription Loading Timeout Fallback
   File: src/lib/SubscriptionContext.tsx
   Issue: isLoading could stay true indefinitely if RevenueCat/backend fails
   Fix: Added 5-second timeout that forces isLoading=false if still loading
        - UI will show Free tier as safe default rather than blank/loading forever
        - Logs warning in DEV mode when timeout triggers
   Invariant: Subscription loading MUST resolve within 5 seconds.

2. User-Scoped Notification Permission Tracking
   File: src/app/activity.tsx
   Issue: Permission asked flag was global, not per-user
   Fix: Changed key from global to user-scoped:
        - OLD: @openinvite_activity_permission_asked
        - NEW: @openinvite_activity_permission_asked_{userId}
   Invariant: Permission prompt tracking is per-user to handle multi-account.

3. "Enable in Settings" CTA for Denied Permission
   File: src/app/notification-settings.tsx
   Issue: When OS permission denied, no clear action path shown
   Fix: Added explicit "Enable in Settings" button that:
        - Only appears when osPermissionStatus === "denied"
        - Opens device Settings via Linking.openSettings()
        - Uses Settings icon with themeColor styling
   Invariant: Denied permission state shows clear remediation path.

PREVIOUS FIXES (PRESERVED)
--------------------------
- Subscription section always renders card (Free/Pro), never blank
- Busy/private events hide titles and disable navigation
- Notification toggle reflects OS permission state (granted/denied/undetermined)
- useFocusEffect refreshes permission status when returning from Settings
- Toggle cannot be ON when OS permission not granted
- Change Color available on ALL events
- Private/busy event detail shows "This time is blocked" message

KEY DIFFS
---------
SubscriptionContext.tsx:
+  const loadingTimeoutRef = useRef<NodeJS.Timeout | null>(null);
+  useEffect(() => {
+    loadingTimeoutRef.current = setTimeout(() => {
+      if (isLoading) setIsLoading(false);
+    }, 5000);
+    return () => { clearTimeout(...) };
+  }, []);

activity.tsx:
-  const ACTIVITY_PERMISSION_ASKED_KEY = "@openinvite_activity_permission_asked";
+  const getActivityPermissionKey = (userId: string) => 
+    `@openinvite_activity_permission_asked_${userId}`;

notification-settings.tsx:
+  {osPermissionStatus === "denied" && (
+    <Pressable onPress={() => Linking.openSettings()}>
+      <Settings size={16} /> Enable in Settings
+    </Pressable>
+  )}

VERIFICATION
------------
✅ yarn typecheck PASS
✅ bash scripts/ai/verify_frontend.sh PASS

QA TEST PLAN
------------
[ ] Settings: Subscription section renders immediately (no blank), updates to Pro if Pro
[ ] Settings: Wait 5+ seconds with network issues → still shows Free card (not stuck loading)
[ ] Activity: First open triggers permission request only if undetermined, only once per user
[ ] Activity: Switch accounts → permission prompt can appear for new user
[ ] Notification settings: Toggle reflects OS permission state
[ ] Notification settings: Toggle updates after changing permission in iOS Settings
[ ] Notification settings: Toggle cannot be ON when OS permission denied/undetermined
[ ] Notification settings: "Enable in Settings" button visible when permission denied
[ ] Notification settings: Clicking "Enable in Settings" opens device Settings

FILES MODIFIED
--------------
- src/lib/SubscriptionContext.tsx (loading timeout fallback)
- src/app/activity.tsx (user-scoped permission tracking)
- src/app/notification-settings.tsx (Enable in Settings CTA + Settings icon import)
--------------
- src/app/settings.tsx (subscription block loading state)
- src/components/FeedCalendar.tsx (EventListItem busy/private handling)
- src/app/activity.tsx (first-open permission request)
- src/app/notification-settings.tsx (OS permission state sync)
- src/app/suggestions.tsx (SuggestionCard @username + bio)
- src/app/calendar.tsx (Change Color ungated - available everywhere)
- src/app/event/[id].tsx (private/busy UX message)
- src/app/event/edit/[id].tsx (private/busy UX message)
- src/app/calendar.tsx (Change Color ungated from isOwner)
