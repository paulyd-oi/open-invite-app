HANDOFF PACKET: Fix Notification Permission Popup Regression (Build 227)
===========================================================================
Date: 2026-02-02
Branch: main
Repo: github.com/paulyd-oi/open-invite-app.git

SUMMARY
-------
Fixed regression in Build 227 where iOS notification permission popup appeared
when entering Settings screen. Root cause: mount effect called checkAndRegisterToken(true)
which triggered requestPermissionsAsync when status was undetermined.

Solution: Changed mount call to checkAndRegisterToken(false) and gated permission
request to only occur when forceRegister=true (explicit user action only).

HARD INVARIANT ENFORCED
-----------------------
Entering Settings must NEVER trigger iOS notification permission prompt.
Permission requests may only occur on explicit user action or onboarding.

ROOT CAUSE
----------
src/hooks/useNotifications.ts:
- Mount useEffect (line 383) called checkAndRegisterToken(true)
- checkAndRegisterToken requested permission if status==='undetermined' (line 241)
- This triggered OS permission prompt on Settings entry

FILES CHANGED
-------------
- src/hooks/useNotifications.ts (2 changes)

EXACT CHANGES
-------------
1. Lines 224-247 (checkAndRegisterToken function):
   Added forceRegister check:
   - if status==='undetermined' AND forceRegister → request permission
   - if status==='undetermined' AND !forceRegister → skip, log, return early
   
2. Line 383 (mount effect):
   Changed: checkAndRegisterToken(true)
   To:      checkAndRegisterToken(false)

DEV LOGGING
-----------
When permission not granted on mount/AppState active:
[PUSH_BOOTSTRAP] Permission not granted; skipping auto registration (no prompt)

BEHAVIOR PRESERVED
------------------
✓ Token registration when permission already granted
✓ Throttling behavior (24h)
✓ AppState active recheck (non-requesting)
✓ Logout stability
✓ Explicit permission request flows (onboarding)

TEST CHECKLIST (MANDATORY)
--------------------------
iOS device / TestFlight:

1. Permission not determined:
   [ ] Open Settings → NO popup
   [ ] Tap explicit enable button (if exists) → popup expected
   
2. Permission already granted:
   [ ] Open Settings → no popup
   [ ] Token registration happens silently
   
3. Background → foreground:
   [ ] Resume app → no popup
   [ ] Permission recheck happens
   
4. Logout:
   [ ] Logout → no crashes
   [ ] No network calls

VERIFICATION
------------
npm run typecheck - PASS
bash scripts/ai/verify_frontend.sh - PASS

NO NEW DEPENDENCIES
-------------------
No changes to imports or dependencies


