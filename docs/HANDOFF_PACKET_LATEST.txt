PHASE E.1 - ACTIVITY FEED AVATAR + DEEP LINK HARDENING
======================================================

SUMMARY
-------
Fixed Activity list to always show valid avatars and implemented strict tap routing priority per E.1 spec.

Changes:
1. Avatar fallback chain expanded (6 URL fields + initials fallback)
2. Initials derived from actorName OR notification title
3. URL validation with http prefix check
4. Strict tap routing: eventId > userId > do nothing (no error toasts)
5. DEV-only warnings for invalid navigation targets

STATUS: COMPLETE
VERIFICATION: PASS

FILES CHANGED
-------------
1. src/app/activity.tsx (+57 lines, -46 lines)
   - parseNotificationData(): Added userId field, expanded avatar URL fallback
   - NotificationCard: Avatar priority: avatarUrl > initials > icon
   - handleNotificationPress(): Strict priority routing, no type-specific branches

2. docs/STATE_OF_THE_APP.md
   - Added E.1 fixes under "Fixed This Session"

3. docs/FINDINGS_LOG.md
   - Added "Activity Feed Avatar + Routing Contract (Canonical)" pattern

KEY DIFFS
---------
# Avatar URL Fallback Chain (Expanded)
- actorAvatarUrl: data.actorAvatarUrl || data.actorImage || data.senderAvatarUrl || data.userAvatarUrl
+ actorAvatarUrl: data.actorAvatarUrl || data.actorImage || data.senderAvatarUrl || data.userAvatarUrl || data.avatarUrl || data.image

# Avatar Display Priority (Never Blank)
- const hasAvatar = !!actorAvatarUrl;
+ const displayName = actorName || (notification.title ? notification.title.split(' ')[0] : undefined);
+ const hasAvatar = !!actorAvatarUrl && actorAvatarUrl.startsWith('http');
+ const hasInitials = !!displayName && displayName.length > 0;

# Tap Routing (Strict Priority)
- if (notification.type === "event_comment") { ... }
- if (notification.type === "friend_request") { router.push("/friends"); }
+ const eventId = data.eventId;
+ if (eventId && typeof eventId === "string") { router.push(`/event/${eventId}`); return; }
+ const userId = data.userId || data.senderId || data.actorId;
+ if (userId && typeof userId === "string") { router.push(`/user/${userId}`); return; }
+ if (__DEV__) { console.warn('[Activity] Notification has no valid navigation target:', {...}); }

# parseNotificationData (Added userId)
+ userId: data.userId || data.senderId || data.actorId,

TEST PLAN
---------
1. Avatar with Remote URL: Shows 44x44 circle image
2. Avatar with Initials Fallback: Shows initials (e.g., "JS" for "John Smith")
3. Avatar from Title Fallback: Extracts first word (e.g., "S" from "Sarah sent...")
4. Avatar Icon Fallback: Shows type-specific icon when no data
5. Event Notification Tap: Navigates to /event/:eventId
6. Friend Notification Tap: Navigates to /user/:userId (if no eventId)
7. Invalid Notification Tap: Stays on screen, DEV console.warn only

WHAT WAS REMOVED
----------------
1. Friends list fallback for friend_request type (now requires userId)
2. Achievement route handling (follows strict priority)
3. Type-specific routing branches (unified to priority system)
4. User-facing error toasts on invalid taps

EDGE CASES HANDLED
------------------
1. Empty notification data: Falls to icon display, stays on screen on tap
2. Invalid JSON parse: Falls to icon display, stays on screen (DEV warn)
3. Non-HTTP URLs: Treated as invalid, falls to initials
4. Missing displayName: Falls to icon (never blank)

COMMIT HASH
-----------
d77fb89

PUSHED
------
YES (main branch)

Agent: GitHub Copilot (Claude Opus 4.5)
Verification: PASS (./scripts/ai/verify_frontend.sh + npm run typecheck)
No breaking changes. Minimal diff achieved.

