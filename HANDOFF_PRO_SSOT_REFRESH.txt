# HANDOFF PACKET: Pro Status SSOT + Refresh Contract

**Date**: 2026-02-03
**Issue**: Pro membership status stays FREE after AWAKEN promo code + purchase

---

## ROOT CAUSE

The "Refresh membership" button only called `subscription.refresh()` which fetches:
1. RevenueCat `customerInfo.entitlements.active.premium`
2. Backend `/api/subscription`

But the UI reads from `useIsPro()` which ALSO checks `useEntitlements()` (backend `/api/entitlements`).

**The backend entitlements query was NOT being refreshed by the Refresh button.**

For promo codes like AWAKEN (applied server-side), the entitlement lives in backend `/api/entitlements` with `plan: "PRO"`, but this query was stale.

---

## SSOT DECISION

**RevenueCat `entitlements.active.premium` is authoritative for purchase state.**

Backend `/api/entitlements` is checked as fallback for admin-granted promos.

`useIsPro()` merges both sources with OR logic: `backendIsPro || revenueCatIsPremium`

---

## FIX IMPLEMENTED

### File: `src/app/settings.tsx`

`handleRefreshEntitlements()` now:
1. Calls `subscription.refresh()` (RevenueCat + /api/subscription)
2. **NEW**: Calls `refreshEntitlements()` (invalidates /api/entitlements query)
3. Shows deterministic toast: "Pro Active" or "Free Plan" or error

### File: `src/lib/SubscriptionContext.tsx`

`fetchSubscription()` now logs with `[PRO_SOT]` prefix showing:
- source=RevenueCat|backend
- entitlements=[...]
- computed isPro=true|false
- uiState after set

### File: `src/lib/entitlements.ts`

`useIsPro()` now logs with `[PRO_SOT][useIsPro]` showing combined check.

---

## PROOF LOGS (Expected Output)

After tapping Refresh with AWAKEN promo applied:

```
[PRO_SOT] === REFRESH START ===
[PRO_SOT] Before: subscription.isPremium= false
[PRO_SOT] Before: userIsPremium (useIsPro)= false
[PRO_SOT] Before: entitlements.plan= FREE
[PRO_SOT] source=RevenueCat enabled= true
[PRO_SOT] entitlements= ["premium"]
[PRO_SOT] computed isPro= true
[PRO_SOT] expectedEntitlementId= premium
[PRO_SOT][useIsPro] ENTITLEMENT_CHECK {
  source_backend_plan: "PRO",
  source_backend_isPro: true,
  source_revenueCat_isPremium: true,
  combined_isPro: true,
  ...
}
[PRO_SOT] === REFRESH COMPLETE ===
```

Toast shows: **"Pro Active - Your Pro membership is active!"**

---

## REPRODUCTION STEPS (AWAKEN Test Account)

1. Create test account or use existing AWAKEN recipient
2. Apply promo code "AWAKEN" via RevenueCat dashboard (1-year Pro)
3. Open app → Settings → observe "Free" status
4. Tap "Refresh membership" button
5. **Expected**: Toast shows "Pro Active", UI updates to show Pro badge
6. Check Metro logs for `[PRO_SOT]` entries confirming entitlement flow

---

## FILES CHANGED

- `src/app/settings.tsx` - handleRefreshEntitlements now calls refreshEntitlements()
- `src/lib/SubscriptionContext.tsx` - [PRO_SOT] logging in fetchSubscription
- `src/lib/entitlements.ts` - [PRO_SOT][useIsPro] logging

---

## VERIFICATION CHECKLIST

- [ ] Refresh button updates UI within 3 seconds
- [ ] Toast shows "Pro Active" / "Free Plan" / specific error
- [ ] Metro logs show [PRO_SOT] entries with entitlement data
- [ ] Purchase success callback triggers same refresh contract
- [ ] App boot calls fetchSubscription (existing behavior, unchanged)

---

## NO BREAKING CHANGES

- Same SSOT logic (OR merge of backend + RevenueCat)
- Same query keys and invalidation patterns
- Only added missing refreshEntitlements() call and logging
